# Модуль Map3DView (Редактор Карт)

## Обзор

Модуль `Map3DView` является центральным компонентом для отображения 3D-сцены в редакторе карт. Он отвечает за инициализацию OpenGL, управление камерой, обработку пользовательского ввода для навигации и делегирование отрисовки различных элементов сцены специализированным классам-рендерерам.

## Архитектура

### `Map3DView` (Класс `Map3DView`)

* **Роль**:
  * Инициализация и управление контекстом QOpenGLWidget.
  * Создание и управление экземпляром `Camera` для навигации в 3D-сцене.
  * Обработка событий клавиатуры и мыши для управления камерой и взаимодействия с объектами сцены (например, выбор вейпоинтов, создание препятствий).
  * Координация общего цикла отрисовки (`paintGL`).
  * Хранение и управление данными, которые должны быть отображены (например, списки вейпоинтов, препятствий, позиция игрока).
  * Передача данных соответствующим рендерерам для их визуализации.
  * Инициализация и управление жизненным циклом всех рендереров.

### `Camera` (Директория `Camera/`, Класс `Camera`)

* **Роль**:
  * Инкапсулирует логику положения, ориентации и проекции камеры.
  * Предоставляет методы для перемещения, вращения камеры и изменения поля зрения (FOV).
  * Генерирует матрицу вида (`viewMatrix`) и матрицу проекции (`projectionMatrix`), необходимые для рендеринга.
  * Подробное описание см. в `tools/MapEditor/src/gui/Map3DView/Camera/README.md`.

### `Renderers` (Директория `Renderers/`, Классы `*Renderer`)

* **Принцип**: Вся логика, связанная с отображением (рендерингом) любых визуальных элементов сцены, включая загрузку шейдеров, управление буферами OpenGL (VAO, VBO) и сами команды отрисовки, должна быть инкапсулирована в отдельных классах-рендерерах, находящихся в директории `Renderers/`. Основной класс `Map3DView` не должен содержать прямой код отрисовки конкретных объектов, а только делегировать эту задачу соответствующим рендерерам.

* **Роль**:
  * Каждый класс в этой директории (например, `WaypointRenderer`, `ObstacleRenderer`, `ConnectionLineRenderer`) отвечает за отрисовку определенного типа визуальных элементов сцены.
  * Инкапсулирует всю специфичную для элемента логику рендеринга:
    * Загрузку и компиляцию GLSL шейдеров (вершинного и фрагментного).
    * Создание и управление OpenGL объектами: Vertex Array Objects (VAO) и Vertex Buffer Objects (VBO).
    * Методы для обновления данных вершин (`updateData`), которые необходимо отрисовать.
    * Метод для выполнения команд отрисовки (`render`) с использованием своих шейдеров и данных.
* **Принцип работы**:
    1. `Map3DView` в методе `initializeGL()` вызывает метод `initialize()` каждого рендерера.
    2. Когда данные для отображения изменяются (например, загружена новая карта, добавлен вейпоинт), `Map3DView` вызывает метод `updateData()` соответствующего рендерера, передавая ему актуальные данные.
  * В методе `paintGL()` класса `Map3DView`, для каждого активного рендерера вызывается его метод `render()`, которому передаются текущие матрицы вида и проекции от камеры.

## Взаимодействие

1. **Инициализация**:
    * `Map3DView` создается и инициализирует OpenGL.
    * `Map3DView` создает экземпляры всех необходимых рендереров и камеры.
    * Вызывается `initializeGL()`, где камера настраивается, и для каждого рендерера вызывается его метод `initialize()`, передавая ему `QOpenGLFunctions` для доступа к функциям OpenGL.
2. **Обновление данных**:
    * Когда в `Map3DView` поступают новые данные (например, через публичные слоты или методы `setWaypoints`, `setObstacles`), он вызывает `updateData()` у соответствующих рендереров.
    * Рендерер преобразует полученные данные в формат, пригодный для OpenGL (массивы вершин, атрибутов) и загружает их в свои VBO.
3. **Отрисовка кадра (`paintGL`)**:
    * `Map3DView` очищает буферы цвета и глубины.
    * Получает актуальные матрицы вида и проекции от `m_camera`.
    * Последовательно вызывает метод `render()` каждого активного рендерера, передавая ему эти матрицы.
    * Каждый рендерер активирует свою шейдерную программу, настраивает uniform-переменные (включая матрицы), биндит свой VAO и выполняет команду отрисовки (например, `glDrawArrays` или `glDrawElements`).
4. **Обработка ввода**:
    * `Map3DView` обрабатывает события `keyPressEvent`, `mousePressEvent`, `mouseMoveEvent`, `wheelEvent`.
    * На основе ввода, обновляются параметры камеры (`m_camera.processKeyboard()`, `m_camera.processMouseMovement()`, `m_camera.processMouseScroll()`).
    * Также могут происходить другие действия, такие как выбор объектов, создание новых (например, точек для `ObstaclePointRenderer` и `ObstacleLineRenderer`), что в свою очередь может привести к обновлению данных у рендереров.
5. **Очистка ресурсов**:
    * В деструкторе `Map3DView` (или в `cleanupRenderers()`, если он есть) вызывается метод `cleanup()` каждого рендерера для освобождения созданных им OpenGL ресурсов (шейдеры, VAO, VBO).

## Преимущества подхода

* **Модульность**: Легко добавлять, изменять или удалять способы отображения различных элементов, не затрагивая основную логику `Map3DView`.
* **Читаемость**: `Map3DView::paintGL()` остается простым и понятным, просто вызывая `render()` для каждого компонента.
* **Инкапсуляция**: Детали реализации рендеринга (шейдеры, атрибуты вершин) скрыты внутри каждого рендерера.
* **Переиспользование**: Теоретически, рендереры можно было бы переиспользовать в других частях приложения, если бы возникла такая необходимость (хотя в данном проекте они тесно связаны с `Map3DView`).

## Ключевые файлы и директории

* `Map3DView.h`, `Map3DView.cpp`: Основной класс виджета.
* `Camera/`: Модуль камеры.
  * `Camera.h`, `Camera.cpp`: Класс камеры.
  * `Camera/README.md`: Описание модуля камеры.
* `Renderers/`: Модуль с классами-рендерерами.
  * `WaypointRenderer.h/cpp`: Рендеринг вейпоинтов.
  * `ConnectionLineRenderer.h/cpp`: Рендеринг линий связи между вейпоинтами.
  * `ObstacleRenderer.h/cpp`: Рендеринг полигональных препятствий.
  * `PlayerMarkerRenderer.h/cpp`: Рендеринг маркера игрока.
  * `ObstaclePointRenderer.h/cpp`: Рендеринг точек создаваемого препятствия.
  * `ObstacleLineRenderer.h/cpp`: Рендеринг линий создаваемого препятствия.
