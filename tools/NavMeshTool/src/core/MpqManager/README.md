# MpqManager и загрузка MPQ-архивов на Sirus

Этот документ суммирует информацию о том, как клиент WoW Sirus загружает MPQ-архивы, и как это должно быть реализовано в `MpqManager` для корректного доступа к игровым данным, особенно для генерации NavMesh.

## Порядок загрузки MPQ (на основе анализа Process Monitor)

Для корректной работы `MpqManager` должен открывать архивы в следующем порядке:

1. **Базовый архив:**
    * `Data/common.mpq` (содержит основные игровые данные и, вероятно, большую часть кастомного контента Sirus, интегрированного из стандартных дополнений и патчей Blizzard, а также основной кастомный контент сервера).

2. **Патчи (применяются последовательно к базовому архиву):**

    * `Data/ruRU/locale-ruRU.mpq` (Основной файл локализации. Большой по размеру.)
    * `Data/patch.mpq`
    * `Data/patch-2.mpq`
    * `Data/patch-3.mpq`

    *Затем применяются кастомные патчи из директории `Data/` (порядок важен):*
    * `Data/patch-4.MPQ` (Предположительно содержит ресурсы для кастомных локаций. Может вызывать SHARING VIOLATION при попытке чтения игрой, если открыт другим приложением.)
    * `Data/patch-5.MPQ`
    * `Data/patch-6.MPQ`
    * `Data/patch-7.mpq`
    * `Data/patch-8.mpq`
    * `Data/patch-9.mpq`
    * `Data/patch-a.mpq`
    * `Data/patch-b.mpq`
    * `Data/patch-c.mpq`
    * `Data/patch-d.mpq`
    * `Data/patch-e.mpq`
    * `Data/patch-f.mpq`
    * `Data/patch-g.mpq`
    * `Data/patch-h.mpq`
    * `Data/patch-i.mpq`
    * `Data/patch-j.mpq`
    * `Data/patch-k.mpq`
    * `Data/patch-l.mpq`
    * `Data/patch-m.mpq`
    * `Data/patch-n.mpq`
    * `Data/patch-o.mpq` (Этот патч может иметь стандартную структуру с listfile)
    * `Data/patch-p.mpq`
    * `Data/patch-q.mpq`

    *Затем применяются патчи локализации из `Data/ruRU/` (порядок важен):*
    * `Data/ruRU/patch-ruRU.mpq` (Общий патч локализации, не специфичный для номера)
    * `Data/ruRU/patch-ruRU-4.mpq`
    * `Data/ruRU/patch-ruRU-5.mpq`
    * `Data/ruRU/patch-ruRU-6.mpq`
    * `Data/ruRU/patch-ruRU-7.mpq`
    * `Data/ruRU/patch-ruRU-8.mpq`
    * `Data/ruRU/patch-ruRU-a.mpq`
    * `Data/ruRU/patch-ruRU-b.mpq`
    * `Data/ruRU/patch-ruRU-c.mpq`
    * `Data/ruRU/patch-ruRU-d.mpq`
    * `Data/ruRU/patch-ruRU-e.mpq`
    * `Data/ruRU/patch-ruRU-f.mpq`
    * `Data/ruRU/patch-ruRU-i.mpq`
    * `Data/ruRU/patch-ruRU-j.mpq`
    * `Data/ruRU/patch-ruRU-k.mpq`

    *Примечание:* Стандартные архивы типа `expansion.mpq`, `lichking.mpq` и их локализованные версии `patch-ruRU-X.mpq` (где X - номер дополнения) на Sirus, скорее всего, являются заглушками или их содержимое интегрировано в `common.mpq` и основной `locale-ruRU.mpq`.

## Особенности кастомных MPQ на Sirus

* **Обфускация имен файлов:** Некоторые кастомные патчи (например, `patch-4.mpq`) могут не содержать читаемый `(listfile)`. Внутренние файлы в таких архивах могут отображаться в MPQ редакторах как `FileXXXXXXX.xxx`. Расширение `.xxx` является заполнителем; фактический тип файла определяется его содержимым (например, были обнаружены WMO-группы по сигнатуре `MOGP`).
* **Содержимое:** "Обфусцированные" архивы, вероятно, содержат кастомную геометрию (M2, WMO) и текстуры (BLP), так как данные локализации (звуки, шрифты, DBC) обычно находятся в `ruRU` патчах.
* **Доступ к обфусцированным файлам:** Для загрузки ресурсов из таких архивов по их каноническим именам (например, `World/Custom/MyObject.m2`) потребуется механизм сопоставления канонического имени с внутренним именем `FileXXXXXXX.xxx` или хешем. Исследование этого механизма является отдельной задачей.

## Замечание по `ruRU` архивам для NavMesh

Файлы и патчи из директории `Data/ruRU/` (например, `locale-ruRU.mpq`, `patch-ruRU-*.mpq`) в основном содержат данные локализации: тексты, звуки, шрифты, локализованные текстуры интерфейса и некоторые DBC. Эти данные **не требуются** для генерации NavMesh, которая зависит от геометрии мира (WDT, ADT, WMO, M2).

**Для генерации NavMesh рекомендуется передавать в `MpqManager` список патчей, ИСКЛЮЧАЯ все архивы из директории `Data/ruRU/`.** Это не повлияет на доступность геометрических данных и может ускорить процесс инициализации. Однако, для полного соответствия поведению клиента при других задачах, эти архивы должны загружаться.
