# Структура ADT файла (версия для WotLK 3.3.5a)

Этот документ описывает структуру ADT (Area Definition Table) файлов, используемых в World of Warcraft WotLK 3.3.5a, на основе анализа множества реальных .adt файлов.

## Общие принципы

* **Порядок байт (Endianness):** Все числовые данные в ADT файлах хранятся в **Little Endian** порядке.
* **Структура чанков:** ADT файлы состоят из последовательности "чанков" (chunks). Каждый чанк имеет следующую общую структуру:
    1. **Идентификатор чанка (Chunk ID):** 4 байта. В файле хранится в обратном порядке символов (например, `MVER` в коде будет `REVM` в файле).
    2. **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает размер данных, следующих *после* этого поля (т.е. не включая сам ID и поле размера).
    3. **Данные чанка (Chunk Data):** Массив байт размером `Chunk Data Size`.

## 1. MVER (Map Version) Chunk

* **Расположение:** Всегда первый чанк в ADT файле.
* **Назначение:** Указывает версию формата ADT файла. Для World of Warcraft WotLK 3.3.5a это значение всегда должно быть 18.
* **Структура на диске (12 байт всего):

    | Смещение (от начала MVER) | Поле               | Тип      | Размер (байты) | Описание                                       |
    | ------------------------- | ------------------ | -------- | -------------- | ---------------------------------------------- |
    | 0                         | `chunk_id`         | char[4]  | 4              | Идентификатор чанка, в файле как `REVM`        |
    | 4                         | `chunk_data_size`  | uint32_t | 4              | Размер данных MVER, всегда равен 4.             |
    | 8                         | `version`          | uint32_t | 4              | Версия формата ADT, для WotLK 3.3.5a равна 18. |

* **Пример байт в файле (Little Endian):** `52 45 56 4D 04 00 00 00 12 00 00 00`
  * `52 45 56 4D` -> ID `REVM` (читается как `MVER`)
  * `04 00 00 00` -> Размер данных = 4
  * `12 00 00 00` -> Версия = 18

## 2. MHDR (Map Header) Chunk

* **Расположение:** Следует сразу за `MVER` чанком.
* **Назначение:** Содержит основную заголовочную информацию карты, включая флаги и, что наиболее важно, смещения к другим ключевым чанкам внутри ADT файла. Поля смещений (такие как `offsetMCIN`, `offsetMTEX` и т.д.), которые следуют за полем `flags` внутри 64-байтного блока данных чанка `MHDR`, являются **относительными смещениями**. Для получения абсолютного адреса целевого чанка в файле, значение такого относительного смещения необходимо прибавить к абсолютному смещению начала самого блока данных `MHDR`. Это базовое смещение блока данных `MHDR` составляет 20 байт (0x14) от начала ADT файла (т.е. оно находится сразу после 12 байт чанка `MVER` и 8 байт заголовка `MHDR`).
* **Размер данных:** Всегда 64 байта для WotLK 3.3.5a (на основе анализа ~500 файлов).

Структура `MHDR` (на основе `SMMapHeader` с wowdev.wiki и анализа файлов WotLK 3.3.5a):

```cpp
struct MHDR_WotLK {
     uint32_t flags;           // Флаги карты: 0x1 = MFBO, 0x2 = Northrend (бит 1)
     uint32_t offsetMCIN;      // Смещение к MCIN (индексы чанков карты), всегда 64
     uint32_t offsetMTEX;      // Смещение к MTEX (текстуры), всегда 4168 в проанализированных
     uint32_t offsetMMDX;      // Смещение к MMDX (имена M2 моделей), вариативно, но всегда >0
     uint32_t offsetMMID;      // Смещение к MMID (ID M2 моделей), вариативно, но всегда >0
     uint32_t offsetMWMO;      // Смещение к MWMO (имена WMO моделей), вариативно, но всегда >0
     uint32_t offsetMWID;      // Смещение к MWID (ID WMO моделей), вариативно, но всегда >0
     uint32_t offsetMDDF;      // Смещение к MDDF (размещение M2/WMO), вариативно, но всегда >0
     uint32_t offsetMODF;      // Смещение к MODF (флаги WMO), вариативно, но всегда >0
     uint32_t offsetMFBO;      // Смещение к MFBO (препятствия для полетов), если (flags & 0x1)
     uint32_t offsetMH2O;      // Смещение к MH2O (глобальная вода), если есть, иначе 0
     uint32_t offsetMTXF;      // Смещение к MTXF (флаги текстур), всегда 0 в WotLK
     uint8_t mamp_value;       // Для MAMP (Cata+), всегда 0 в WotLK
     uint8_t padding[3];       // Выравнивание, всегда 00 00 00
     uint32_t unused[3];      // Не используется, всегда все нули
     // Общий размер: 64 байта
}; 64
```

**Поля и их значения для WotLK 3.3.5a (на основе анализа ~500 файлов):**

* **`flags` (4 байта, `uint32_t`):**
  * Назначение: Определяет некоторые глобальные свойства ADT.
  * В проанализированных файлах WotLK 3.3.5a это поле принимало следующие значения:
    * `0x00000000`: Стандартное значение, дополнительных флагов нет (большинство файлов Азерота/Калимдора).
    * `0x00000001`: Установлен флаг `mhdr_MFBO` (бит 0). Указывает на наличие чанка `MFBO` (препятствия для полетов). Встречается в основном в файлах Запределья и некоторых рейдовых зонах Нордскола.
    * `0x00000003`: Установлены флаги `mhdr_MFBO` (бит 0) и предполагаемый флаг `mhdr_northrend` (бит 1). Встречено в файлах рейдовых зон Нордскола (например, `IcecrownCitadel_35_31.adt`, `NexusRaid_29_30.adt`). Это указывает на то, что бит 1 может использоваться для обозначения карт Нордскола или их специфических особенностей.

* **`offsetMCIN` (4 байта, `uint32_t`):**
  * Назначение: Смещение к началу данных чанка `MCIN` (Map Chunk Index Names).
  * В проанализированных файлах значение этого относительного смещения **всегда `0x0040` (64 в десятичной)**. Прибавив это к базовому смещению данных MHDR (0x14), получаем абсолютное смещение MCIN: `0x14 + 0x40 = 0x54` (84 в десятичной) от начала файла.

* **`offsetMTEX` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MTEX` (список имен текстур, используемых на карте).
  * В проанализированных файлах значение этого относительного смещения **всегда `0x1048` (4168 в десятичной)**. Прибавив это к базовому смещению данных MHDR (0x14), получаем абсолютное смещение MTEX: `0x14 + 0x1048 = 0x105C` (4188 в десятичной) от начала файла. Этот адрес соответствует началу чанка MTEX сразу после полного окончания чанка MCIN.

* **`offsetMMDX` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MMDX` (список имен файлов моделей `.m2`, используемых на карте).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMMID` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MMID` (список ID для уникальных экземпляров M2 моделей из `MMDX`).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMWMO` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MWMO` (список имен файлов WMO (World Map Objects), используемых на карте).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMWID` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MWID` (список ID для уникальных экземпляров WMO из `MWMO`).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMDDF` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MDDF` (Map Data Doodad File).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMODF` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MODF` (Map Object Definition Flags - информация о флагах и свойствах экземпляров WMO).
  * Значение **варьируется**, но во всех проанализированных файлах было **ненулевым**.

* **`offsetMFBO` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MFBO` (Map Flight Boundaries Obstacles).
  * Используется, если установлен флаг `mhdr_MFBO` (бит 0) в поле `flags`. Если флаг установлен, смещение **ненулевое и варьируется**. Если флаг не установлен, смещение **всегда `0`**.

* **`offsetMH2O` (4 байта, `uint32_t`):**
  * Назначение: Смещение к глобальному чанку `MH2O` (информация о воде для всей карты).
  * В проанализированных файлах WotLK 3.3.5a это поле **ненулевое и варьируется** примерно в 42% случаев, указывая на использование глобального `MH2O`. В остальных ~58% случаев поле **равно `0`**, и информация о воде (`MCWL`, `MCLQ`) вероятно хранится только на уровне `MCNK` чанков.

* **`offsetMTXF` (4 байта, `uint32_t`):**
  * Назначение: Смещение к чанку `MTXF` (Texture Flags, обычно связано с `MAMP` из TBC+).
  * В проанализированных файлах WotLK 3.3.5a это поле **всегда `0`**.

* **`mamp_value` (1 байт, `uint8_t`):**
  * Назначение: Используется в Cataclysm+ для `MAMP` чанка.
  * В проанализированных файлах WotLK 3.3.5a это поле **всегда `0`**.

* **`padding[3]` (3 байта, `uint8_t[3]`):**
  * Назначение: Выравнивание структуры.
  * В проанализированных файлах WotLK 3.3.5a эти байты **всегда `00 00 00`**.

* **`unused[3]` (12 байт, `uint32_t[3]`):**
  * Назначение: Неиспользуемые поля.
  * В проанализированных файлах WotLK 3.3.5a эти байты **всегда содержат нули**.

**Краткие итоги по MHDR на основе анализа ~500 файлов:**

* Размер MHDR всегда 64 байта.
* `flags` может быть 0x0, 0x1 (MFBO) или 0x3 (MFBO + Northrend).
* `offsetMCIN` всегда 64. `offsetMTEX` всегда 4168.
* Смещения к M2/WMO данным (`MMDX` до `MODF`) всегда > 0, но вариативны.
* `offsetMFBO` коррелирует с флагом 0x1.
* `offsetMH2O` опционален (0 или >0).
* `offsetMTXF`, `mamp_value`, `padding`, `unused` всегда 0 или стандартные значения.

**Важно:** Отсутствие смещения (значение 0) для опциональных чанков (`MFBO` если флаг не установлен, `MH2O`, `MTXF`) означает, что соответствующий тип данных или чанк не используется в данном конкретном ADT файле.

## 3. MCIN (Map Chunk Index Names) Chunk

* **Расположение:** Следует сразу за данными чанка `MHDR`.
* **Назначение:** Содержит массив из 256 записей, каждая из которых предоставляет информацию (смещение и размер) для одного из 256 чанков карты (`MCNK`) этого ADT файла.
* **Структура заголовка MCIN (8 байт):**
  * **Идентификатор чанка (Chunk ID):** `MCIN` (в файле как `NICM`).
  * **Размер данных чанка (Chunk Data Size):** Всегда `4096` байт (256 записей * 16 байт/запись) для WotLK 3.3.5a.
* **Данные чанка:** Последовательность из 256 экземпляров структуры `MCNK_info`.

Структура одной записи `MCNK_info` (16 байт):

```cpp
struct MCNK_info { // 16 байт
    uint32_t offset;    // Смещение к данным MCNK чанка (от начала ADT файла)
    uint32_t size;      // Размер MCNK чанка (включая его заголовок и все под-чанки)
    uint32_t flags = 0;     // Флаги для MCNK (в WotLK всегда 0)
    uint32_t asyncId = 0;   // ID для асинхронной загрузки (в WotLK всегда 0)
}; 4096
```

**Поля `MCNK_info` и их значения для WotLK 3.3.5a (на основе анализа ~500 файлов):**

* **`offset` (4 байта, `uint32_t`):**
  * Назначение: Абсолютное смещение от начала ADT файла до начала соответствующего `MCNK` чанка (его заголовка).
  * В проанализированных файлах это значение **всегда было ненулевым** для каждой из 256 записей.
  * Значения варьируются, так как `MCNK` чанки располагаются последовательно или с учетом других данных.

* **`size` (4 байта, `uint32_t`):**
  * Назначение: Общий размер соответствующего `MCNK` чанка в байтах (включая его заголовок `MCNK` и все его данные/под-чанки).
  * В проанализированных файлах это значение **всегда было ненулевым** для каждой из 256 записей.
  * Значения варьируются в зависимости от содержимого каждого `MCNK`.

* **`flags` (4 байта, `uint32_t`):**
  * Назначение: Флаги, специфичные для отдельного `MCNK` чанка.
  * В проанализированных файлах WotLK 3.3.5a это поле **всегда `0x00000000`** для каждой из 256 записей во всех файлах.

* **`asyncId` (4 байта, `uint32_t`):**
  * Назначение: Идентификатор для асинхронной загрузки данных чанка.
  * В проанализированных файлах WotLK 3.3.5a это поле **всегда `0x00000000`** для каждой из 256 записей во всех файлах.

**Краткие итоги по MCIN на основе анализа ~500 файлов:**

* Чанк `MCIN` всегда следует за `MHDR`.
* Размер его данных всегда 4096 байт.
* Содержит 256 записей `MCNK_info`.
* В каждой `MCNK_info`: `offset` и `size` всегда > 0 и вариативны; `flags` и `asyncId` всегда 0.

## 4. MTEX (Map Texture paths) Chunk

* **Расположение:** Обычно следует сразу за чанком `MCIN`. Смещение к `MTEX` указывается полем `offsetMTEX` в данных чанка `MHDR`. Абсолютное смещение `MTEX` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMTEX_из_данных_MHDR>`. Для большинства проанализированных файлов WotLK 3.3.5a это `0x14 + 0x1048 = 0x105C` от начала файла.

* **Назначение:** Содержит список имен файлов текстур (в формате `.blp`), которые используются для отрисовки ландшафта на данном тайле карты (ADT-файле). Каждое имя файла представляет собой строку символов, завершающуюся нулевым байтом (`\0`).

* **Структура заголовка MTEX (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MTEX`, в файле хранится как `XTEM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех имен файлов текстур, включая их нулевые терминаторы.

* **Данные чанка (Chunk Data):** Последовательность строк, каждая из которых является полным путем к файлу текстуры (например, `Tileset\MyZone\MyTexture.blp`) и завершается нулевым байтом. Если для данного ADT-файла не определено специфичных текстур через `MTEX`, то `Chunk Data Size` может быть равен 0, и, соответственно, данных не будет.

    Примерная структура данных в коде (концептуально):

    ```cpp
    struct MTEX_ChunkData {
        // Фактически, это просто последовательность char* (строк C-стиля)
        char texture_filename_1[]; // Null-terminated string, e.g., "Tileset\\Path\\Texture1.blp\0"
        char texture_filename_2[]; // Null-terminated string, e.g., "Tileset\\Path\\Texture2.blp\0"
         char texture_filename_N[]; // Null-terminated string
    };
    ```

* **Пример байт в файле для одного пути к текстуре:**
    Предположим, путь к текстуре: `Tileset\MyTerrain\Grass01.blp` (длина 29 символов + 1 нулевой байт = 30 байт).
  * Байты ID: `58 45 54 4D` (`XTEM`)
  * Байты размера данных (30 в decimal = `0x1E` in hex, little-endian): `1E 00 00 00`
  * Байты имени файла (ASCII + `\0`): `54 69 6C 65 73 65 74 5C 4D 79 54 65 72 72 61 69 6E 5C 47 72 61 73 73 30 31 2E 62 6C 70 00`

* **Итоги анализа ~500 ADT файлов (WotLK 3.3.5a) с исправленной логикой поиска MTEX:**
  * Чанк `MTEX` был найден и успешно проанализирован во всех 495 исследованных файлах.
  * Поле `offsetMTEX` в данных `MHDR` для этих файлов consistently содержит относительное значение `0x1048`. Абсолютное смещение `MTEX` рассчитывается как `0x14 (база данных MHDR) + 0x1048 = 0x105C`.
  * Размер данных `MTEX` (`Chunk Data Size`) варьируется. Примерно в 33 из 495 файлов (около 6.7%) был обнаружен `MTEX` с нулевым размером данных, что указывает на отсутствие явных путей к текстурам в этих чанках.
  * Всего в проанализированных файлах было обнаружено 135 уникальных путей к текстурам.
  * Пример часто используемой текстуры: `"Tileset\Winterspring Grove\WinterspringSnowSolid.blp"`.

## 5. MMDX (Map Model paths) Chunk

* **Расположение:** Смещение к чанку `MMDX` указывается полем `offsetMMDX` в данных чанка `MHDR`. Абсолютное смещение `MMDX` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMMDX_из_данных_MHDR>`. Поле `offsetMMDX` в `MHDR` всегда ненулевое в WotLK 3.3.5a.

* **Назначение:** Содержит список имен файлов моделей формата `.m2` (Doodad M2 Models), которые используются или на которые есть ссылки в данном тайле карты (ADT-файле). Каждое имя файла представляет собой строку символов, завершающуюся нулевым байтом (`\0`). Эти модели далее индексируются и размещаются через чанки `MMID` и `MDDF`.

* **Структура заголовка MMDX (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MMDX`, в файле хранится как `XDMM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех имен файлов моделей, включая их нулевые терминаторы. Этот размер может быть равен 0.

* **Данные чанка (Chunk Data):** Последовательность строк, каждая из которых является полным путем к файлу модели (например, `World\Azeroth\Elwynn\PassiveDoodads\Trees\ElwynnTree01.m2`) и завершается нулевым байтом.

    Примерная структура данных в коде (концептуально):

    ```cpp
    struct MMDX_ChunkData {
        // Фактически, это просто последовательность char* (строк C-стиля)
        char model_filename_1[]; // Null-terminated string, e.g., "Path\To\Model1.m2\0"
        char model_filename_2[]; // Null-terminated string, e.g., "Path\To\Model2.m2\0"
        // ...
        char model_filename_N[]; // Null-terminated string
    };
    ```

* **Анализ и особенности MMDX в WotLK 3.3.5a:**
  * Поле `offsetMMDX` в `MHDR` всегда указывает на валидное смещение.
  * **"Пустой" MMDX:** Если `Chunk Data Size` для `MMDX` равен 0, **И** непосредственно за 8-байтовым заголовком `MMDX` (ID + размер=0) в файле следует заголовок чанка `MMID` (ID: `MMID`, в файле как `DIMM`), то такой `MMDX` чанк считается "пустым". Он не содержит списка моделей, и тайл карты не использует уникальные M2 модели через этот механизм.
  * **"Непустой" MMDX:**
    * Если `Chunk Data Size` > 0, то чанк содержит список путей к M2 моделям, разделенных нулевыми байтами. Эти пути используются для загрузки соответствующей геометрии и текстур моделей.
    * Существует также редкий случай, когда `Chunk Data Size` = 0, но следующий заголовок чанка *не* `MMID`. В этой ситуации `MMDX` структурно присутствует и не является "классически пустым", но не несет данных о моделях. Такой случай обрабатывается как "непустой" с точки зрения структуры, но со списком моделей равным нулю.
  * Скриптовый анализ показал, что большинство ADT файлов содержат "пустые" `MMDX` чанки. Однако, файлы для локаций с большим количеством уникальных объектов (например, города, подземелья) часто содержат "непустые" `MMDX` с обширными списками моделей.
  * **Пример фрагмента данных MMDX (hex) для одной модели `WORLD\EXPANSION01\DOODADS\GENERIC\OUTLAND\ROCKS\OVERHANGROCK_LARGE_01.M2\0`:**
    * Заголовок: `58 44 4d 4d 49 00 00 00` (`XDMM` - ID, `49 00 00 00` - размер данных 73 байта)
    * Данные (путь + `\0`): `57 4f 52 4c ... 31 2e 4d 32 00`

## 6. MMID (Map Model ID / Instance lookup) Chunk

* **Расположение:** Смещение к чанку `MMID` указывается полем `offsetMMID` в данных чанка `MHDR`. Абсолютное смещение `MMID` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMMID_из_данных_MHDR>`. Поле `offsetMMID` в `MHDR` всегда ненулевое в WotLK 3.3.5a, если есть M2 модели, использующие этот механизм.

* **Назначение:** Содержит список 4-байтовых смещений (`uint32_t`). Каждое смещение указывает на начальную позицию null-terminated строки (пути к файлу модели `.m2`) внутри блока данных чанка `MMDX`. Таким образом, `MMID` формирует индексированный список уникальных типов моделей, определенных в `MMDX`, которые фактически используются или на которые есть ссылки на данном тайле карты. Чанк `MDDF` затем будет использовать порядковые номера (индексы) записей из этого `MMID` чанка для размещения конкретных экземпляров этих моделей на карте.

* **Структура заголовка MMID (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MMID`, в файле хранится как `DIMM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех 4-байтовых смещений, следующих далее. Этот размер должен быть кратен 4. Если размер равен 0, то чанк `MMID` не содержит данных (нет ссылок на модели из `MMDX`).

* **Данные чанка (Chunk Data):** Последовательность 4-байтовых значений `uint32_t` (little-endian). Каждое значение является смещением от начала *данных* чанка `MMDX` (т.е. после 8-байтового заголовка `MMDX`).

    Примерная структура данных в коде (концептуально):

    ```cpp
    struct MMID_ChunkData {
        uint32_t mmdx_offset_for_model_1; // Смещение к первой модели в данных MMDX
        uint32_t mmdx_offset_for_model_2; // Смещение ко второй модели в данных MMDX
        // ...
        uint32_t mmdx_offset_for_model_N;
    };
    ```

    Количество записей (смещений) в `MMID` равно `Chunk Data Size / 4`.

* **Анализ и особенности MMID в WotLK 3.3.5a:**
  * Если чанк `MMDX` пуст (не содержит путей к моделям), то и чанк `MMID` обычно будет иметь размер данных 0.
  * Каждое смещение в `MMID` должно указывать на корректное начало строки в `MMDX`.
  * Скриптовый анализ подтверждает, что данные `MMID` представляют собой массив таких смещений.
  * **Пример фрагмента данных MMID (hex) и его связь с MMDX:**
    Предположим, `MMDX` содержит:
    `[смещение 0x0000 в MMDX данных] WORLD\AZEROTH\...\Tree01.M2\0`
    `[смещение 0x0046 в MMDX данных] WORLD\LORDAERON\...\Rock03.M2\0`

    Тогда `MMID` может содержать (пример для двух записей):
    * Заголовок MMID: `44 49 4d 4d 08 00 00 00` (`DIMM`, размер данных 8 байт)
    * Данные MMID (8 байт):
      `00 00 00 00` (ссылается на `Tree01.M2` по смещению 0x0000 в `MMDX`)
      `46 00 00 00` (ссылается на `Rock03.M2` по смещению 0x0046 в `MMDX`)

Далее должны следовать описания чанков `MWMO`, `MWID`, `MDDF`, `MODF` и т.д.

## 7. MWMO (Map WMO paths) Chunk

* **Расположение:** Смещение к чанку `MWMO` указывается полем `offsetMWMO` в данных чанка `MHDR`. Абсолютное смещение `MWMO` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMWMO_из_данных_MHDR>`. Поле `offsetMWMO` в `MHDR` всегда ненулевое в WotLK 3.3.5a, если тайл использует WMO через этот механизм.

* **Назначение:** Содержит список имен файлов моделей формата `.wmo` (World Map Objects), которые используются или на которые есть ссылки в данном тайле карты (ADT-файле). Каждое имя файла представляет собой строку символов, завершающуюся нулевым байтом (`\0`). Эти WMO далее индексируются и размещаются через чанки `MWID` и `MODF`.

* **Структура заголовка MWMO (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MWMO`, в файле хранится как `OMWM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех имен файлов WMO, включая их нулевые терминаторы. Этот размер может быть равен 0.

* **Данные чанка (Chunk Data):** Последовательность строк, каждая из которых является полным путем к файлу WMO (например, `WORLD\WMO\AZEROTH\BUILDINGS\ELWYNN_ABBEY\ELWYNN_ABBEY.WMO`) и завершается нулевым байтом.

    Примерная структура данных в коде (концептуально):

    ```cpp
    struct MWMO_ChunkData {
        // Фактически, это просто последовательность char* (строк C-стиля)
        char wmo_filename_1[]; // Null-terminated string, e.g., "Path\\To\\WMO1.wmo\0"
        char wmo_filename_2[]; // Null-terminated string, e.g., "Path\\To\\WMO2.wmo\0"
        // ...
        char wmo_filename_N[]; // Null-terminated string
    };
    ```

* **Анализ и особенности MWMO в WotLK 3.3.5a:**
  * Поле `offsetMWMO` в `MHDR` обычно указывает на валидное смещение, если WMO используются.
  * Если `Chunk Data Size` для `MWMO` равен 0, то чанк не содержит списка WMO, и тайл карты не использует уникальные WMO через этот механизм. В этом случае чанк `MWID` также будет иметь размер данных 0.
  * Скриптовый анализ показывает, что многие ADT файлы (особенно те, что описывают открытые пространства без крупных уникальных строений) могут иметь `MWMO` с нулевым размером данных. Файлы для локаций с большим количеством WMO (города, подземелья, специальные зоны) содержат `MWMO` с обширными списками файлов.
  * **Пример фрагмента данных MWMO (hex) для одного WMO `WORLD\WMO\...\ELWYNN_ABBEY.WMO\0`:**
    * Заголовок: `4F 4D 57 4D XX XX XX XX` (`OMWM` - ID, `XX XX XX XX` - размер данных)
    * Данные (путь + `\0`): `57 4F 52 4C 44 5C ... 4F 00`

## 8. MWID (Map WMO ID / Instance lookup) Chunk

* **Расположение:** Смещение к чанку `MWID` указывается полем `offsetMWID` в данных чанка `MHDR`. Абсолютное смещение `MWID` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMWID_из_данных_MHDR>`. Поле `offsetMWID` в `MHDR` всегда ненулевое в WotLK 3.3.5a, если есть WMO, использующие этот механизм, и `MWMO` не пуст.

* **Назначение:** Содержит список 4-байтовых смещений (`uint32_t`). Каждое смещение указывает на начальную позицию null-terminated строки (пути к файлу WMO `.wmo`) внутри блока данных чанка `MWMO`. Таким образом, `MWID` формирует индексированный список уникальных типов WMO, определенных в `MWMO`, которые фактически используются или на которые есть ссылки на данном тайле карты. Чанк `MODF` затем будет использовать порядковые номера (индексы) записей из этого `MWID` чанка для размещения конкретных экземпляров этих WMO на карте.

* **Структура заголовка MWID (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MWID`, в файле хранится как `DIWM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех 4-байтовых смещений, следующих далее. Этот размер должен быть кратен 4. Если размер равен 0, то чанк `MWID` не содержит данных (нет ссылок на WMO из `MWMO`).

* **Данные чанка (Chunk Data):** Последовательность 4-байтовых значений `uint32_t` (little-endian). Каждое значение является смещением от начала *данных* чанка `MWMO` (т.е. после 8-байтового заголовка `MWMO`).

    Примерная структура данных в коде (концептуально):

    ```cpp
    struct MWID_ChunkData {
        uint32_t mwmo_offset_for_wmo_1; // Смещение к первому WMO в данных MWMO
        uint32_t mwmo_offset_for_wmo_2; // Смещение ко второму WMO в данных MWMO
        // ...
        uint32_t mwmo_offset_for_wmo_N;
    };
    ```

    Количество записей (смещений) в `MWID` равно `Chunk Data Size / 4`.

* **Анализ и особенности MWID в WotLK 3.3.5a:**
  * Если чанк `MWMO` пуст (не содержит путей к WMO), то и чанк `MWID` всегда будет иметь размер данных 0.
  * Каждое смещение в `MWID` должно указывать на корректное начало строки в данных `MWMO`.
  * Скриптовый анализ подтверждает, что данные `MWID` представляют собой массив таких смещений, корректно ссылающихся на строки в `MWMO`.
  * **Пример связи `MWMO` и `MWID` (на основе анализа `Stratholme_37_25.adt`):**
        Предположим, `MWMO` данные содержат (упрощенно):
        `[смещение 0x0000 в MWMO данных] WORLD\...\MD_CAVETUNNEL01.WMO\0`
        `[смещение 0x0035 в MWMO данных] WORLD\...\UNDEADZIGGURAT.WMO\0`
        `[смещение 0x0087 в MWMO данных] WORLD\...\STRATHOLME_B.WMO\0`

        Тогда `MWID` данные (размер 12 байт) будут содержать:
        `00 00 00 00` (ссылается на `MD_CAVETUNNEL01.WMO` по смещению 0x0000 в `MWMO`)
        `35 00 00 00` (ссылается на `UNDEADZIGGURAT.WMO` по смещению 0x0035 в `MWMO`)
        `87 00 00 00` (ссылается на `STRATHOLME_B.WMO` по смещению 0x0087 в `MWMO`)

Далее должны следовать описания чанков `MDDF`, `MODF` и т.д.

## 9. MDDF (Map Data Doodad File) Chunk

* **Расположение:** Смещение к чанку `MDDF` указывается полем `offsetMDDF` в данных чанка `MHDR`. Абсолютное смещение `MDDF` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMDDF_из_данных_MHDR>`. Поле `offsetMDDF` в `MHDR` всегда ненулевое в WotLK 3.3.5a, если тайл содержит размещенные M2 модели (doodads).

* **Назначение:** Содержит информацию о размещении каждого экземпляра M2 модели (doodad) на карте. Сюда входят уникальный идентификатор, ссылка на тип модели (через `MMID`), позиция, ориентация и масштаб.

* **Структура заголовка MDDF (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MDDF`, в файле хранится как `FDDM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех записей о doodad'ах. Этот размер должен быть кратен 36 байтам (размер одной записи). Если размер равен 0, то чанк `MDDF` не содержит данных.

* **Данные чанка (Chunk Data):** Последовательность записей, каждая из которых имеет следующую структуру (36 байт):

    ```cpp
    struct SMDoodadDef_WotLK { // 36 байт
        uint32_t nameId;        // Индекс в чанк MMID, который в свою очередь ссылается на MMDX для получения имени файла M2 модели.
        uint32_t uniqueId;      // Уникальный идентификатор для этого экземпляра doodad'а. Важен для скриптов и состояния мира.
        C3Vector position;      // Глобальные мировые координаты (X, Y, Z) расположения doodad'а. 
                                // (Примечание: Z является высотой. Большие значения Z могут указывать на глобальное смещение всей зоны по оси Z).
        C3Vector rotation;      // Углы поворота doodad'а по осям X, Y, Z (в градусах).
        uint16_t scale;         // Масштаб объекта. Значение 1024 соответствует нормальному масштабу (1.0f).
        uint16_t flags;         // Флаги, влияющие на отображение или поведение doodad'а (например, 0x1 - biodome, т.е. на открытом воздухе).
    }; // Размер одной записи = 4+4+12+12+2+2 = 36 байт
    ```

    Количество записей (doodad'ов) в `MDDF` равно `Chunk Data Size / 36`.

* **Интерпретация координат (важно):**
  * `position` (X, Y, Z): Координаты являются глобальными мировыми координатами.
    * X: Ось Север/Юг (положительные значения обычно Север).
    * Y: Ось Запад/Восток (положительные значения обычно Запад, согласно wowdev, но требует проверки для конкретной оси).
    * Z: Вертикальная высота. **Текущая гипотеза**: большие значения Z (например, 14000+ для Вестфолла) указывают на то, что вся игровая зона (тайл ADT) может иметь значительное общее смещение по оси Z относительно глобального нуля мира (уровня моря). Таким образом, `Z_position = Z_глобальный_оффсет_зоны + Z_локальная_высота_объекта_в_зоне`.
  * `rotation` (X, Y, Z): Углы поворота в градусах вокруг соответствующих осей.

* **Анализ и особенности MDDF в WotLK 3.3.5a:**
  * Если `MMDX` и `MMID` пусты или отсутствуют, то информация из `MDDF` не сможет быть полностью разрешена до имен файлов моделей, но геометрические данные все еще будут присутствовать.
  * Скриптовый анализ показывает, что большинство ADT файлов содержат ненулевой `MDDF` чанк, если на карте есть какие-либо декоративные объекты.
  * Поле `uniqueId` может использоваться игрой для отслеживания состояния конкретных объектов.
  * Поле `scale` чаще всего равно 1024 (масштаб 1.0), но может отличаться для объектов разного размера.
  * Поле `flags` часто равно 0 для стандартных doodad'ов, но может содержать и другие значения.

Далее должно следовать описание чанка `MODF`.

## 10. MODF (Map Object Definition File) Chunk

* **Расположение:** Смещение к чанку `MODF` указывается полем `offsetMODF` в данных чанка `MHDR`. Абсолютное смещение `MODF` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMODF_из_данных_MHDR>`. Поле `offsetMODF` в `MHDR` всегда ненулевое в WotLK 3.3.5a, если тайл содержит размещенные WMO модели.

* **Назначение:** Содержит информацию о размещении каждого экземпляра WMO (World Map Object) на карте. Сюда входят уникальный идентификатор, ссылка на тип WMO (через `MWID`), "сырые" данные о позиции и ориентации, ограничивающий параллелепипед (extents), флаги и информацию о наборах (doodad set, name set).

* **Структура заголовка MODF (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MODF`, в файле хранится как `FDOM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает на общий размер (в байтах) всех записей о WMO. Этот размер должен быть кратен 64 байтам (размер одной записи). Если размер равен 0, то чанк `MODF` не содержит данных.

* **Данные чанка (Chunk Data):** Последовательность записей, каждая из которых имеет следующую структуру (64 байта):

    ```cpp
    struct SMMapObjDef_WotLK { // 64 байта
        uint32_t nameId;        // Индекс в чанк MWID, который в свою очередь ссылается на MWMO для получения имени файла WMO модели.
        uint32_t uniqueId;      // Уникальный идентификатор для этого экземпляра WMO. Важен для скриптов и состояния мира.
        C3Vector position;      // "Сырые" координаты (X, Y, Z) из файла. 
                                // Эти координаты хранятся в специфической для MODF системе (предположительно Y-Up) 
                                // и требуют преобразования для получения стандартных мировых Z-Up координат WoW.
        C3Vector rotation;      // Углы поворота WMO по осям X, Y, Z (в градусах).
        CAaBox   extents;       // Ограничивающий параллелепипед WMO (AABB - Axis Aligned Bounding Box).
                                // Содержит две C3Vector: min_corner и max_corner.
        uint16_t flags;         // Флаги, влияющие на отображение или поведение WMO (см. enum MODFFlags на wowdev.wiki).
        uint16_t doodadSet;     // Индекс набора doodad'ов (MODS чанк) внутри WMO файла. Определяет, какие "внутренние" декорации WMO будут отображаться.
        uint16_t nameSet;       // Индекс набора имен для WMO. Позволяет использовать одну модель WMO с разными названиями в игре.
        uint16_t scale_or_padding; // В WotLK это поле, скорее всего, является выравниванием (padding) и не используется как масштаб. 
                                   // Масштаб WMO обычно определяется самой моделью.
    }; // Размер одной записи = 4+4+12+12+24+2+2+2+2 = 64 байта
    ```

    Количество записей (WMO) в `MODF` равно `Chunk Data Size / 64`.

* **Интерпретация полей (WotLK 3.3.5a):**
  * `position` (X, Y, Z): Как указано выше, это "сырые" координаты из файла. **Очень важно**: согласно wowdev.wiki, эти координаты для `MODF` представлены в системе Y-Up и требуют специального преобразования (включая вычитание из константы `32*TILESIZE`) для получения корректных мировых Z-Up координат. Вторая компонента (Y) этих "сырых" координат, вероятно, представляет высоту в этой Y-Up системе `MODF`.
  * `rotation` (X, Y, Z): Углы поворота в градусах.
  * `extents` (minX, minY, minZ, maxX, maxY, maxZ): Определяет объем WMO в пространстве. Эти координаты также, вероятно, соответствуют той же системе, что и `position`, и могут требовать аналогичного преобразования.
  * `flags`: См. `MODFFlags` на wowdev.wiki. Для WotLK многие продвинутые флаги (LOD, FileDataID) не используются.
  * `doodadSet`: Обычно 0, если не используются специфичные наборы внутренних doodad'ов WMO.
  * `nameSet`: Позволяет вариативность имен (например, таверна в Златоземье и Североземье).
  * `scale_or_padding`: В WotLK обычно 0, масштаб WMO заложен в самом файле модели.

* **Анализ и особенности MODF в WotLK 3.3.5a:**
  * Чанк `MODF` используется для размещения всех крупных объектов на карте (здания, подземелья, мосты и т.д.).
  * Корректная интерпретация и преобразование координат из `MODF.position` критически важны для правильного отображения WMO на карте.
  * Поля `extents` используются для определения видимости (frustum culling) и столкновений (collision detection).

Далее следует описание чанка `MFBO` или `MH2O` (или сразу переход к `MCNK`).

## 11. MH2O (Map H2O - Liquid Data) Chunk (Work In Progress - структура уточняется)

* **Расположение:** Смещение к глобальному чанку `MH2O` указывается полем `offsetMH2O` в данных чанка `MHDR`. Абсолютное смещение `MH2O` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMH2O_из_данных_MHDR>`. Если `offsetMH2O` в `MHDR` равен 0, глобальный чанк `MH2O` отсутствует (жидкость может быть определена локально в `MCNK` через `MCLQ`, либо ее нет). Этот чанк появился в WotLK и заменяет старый `MCLQ` для глобального определения жидкостей.

* **Назначение:** Содержит подробную информацию о размещении и свойствах различных типов жидкостей (вода, лава, слизь и т.д.) на всей территории ADT-тайла. Позволяет гибко описывать как большие водоемы, так и маленькие лужи или реки, покрывающие часть MCNK-чанков.

* **Важно:** Все смещения, хранящиеся *внутри* данных чанка `MH2O` (например, `offset_instances`, `offset_attributes`, `offset_exists_bitmap`, `offset_vertex_data`), являются **относительными от начала данных самого чанка `MH2O`** (т.е. после 8-байтового заголовка `MH2O`: ID 'O2HM' + размер).

* **Общая структура чанка `MH2O`:**
    1. **Заголовок `MH2O` (8 байт):**
        * `char[4] chunk_id`: Идентификатор чанка (`MH2O`, в файле как `O2HM`).
        * `uint32_t chunk_data_size`: Общий размер всех данных чанка `MH2O`, следующих за этим полем.
    2. **Массив заголовков `SMLiquidChunk` (256 записей * 12 байт/запись = 3072 байта):** Расположен сразу после заголовка `MH2O`. По одной записи для каждого из 16x16 `MCNK` на тайле.
    3. **Блок данных `SMLiquidInstance`:** Массив структур, описывающих каждый "слой" или "экземпляр" жидкости. Располагается после массива `SMLiquidChunk`. Смещения к конкретным экземплярам для каждого MCNK хранятся в `SMLiquidChunk`.
    4. **Блоки данных атрибутов, битовых карт и вершин:** Фактические данные, на которые ссылаются из `SMLiquidChunk` и `SMLiquidInstance`. Эти блоки обычно плотно упакованы после блока `SMLiquidInstance`.

* **Структура `SMLiquidChunk` (12 байт, по одной для каждого из 256 MCNK):**

    ```cpp
    struct SMLiquidChunk_WotLK { // 12 байт
        uint32_t offset_instances;    // Относительное смещение к SMLiquidInstance[layer_count] (или одной SMLiquidInstance если layer_count=1)
        uint32_t layer_count;         // Количество слоев жидкости в данном MCNK. Если 0, жидкость отсутствует.
        uint32_t offset_attributes;   // Относительное смещение к mh2o_chunk_attributes для этого MCNK. Может быть 0.
    };
    ```

* **Структура `mh2o_chunk_attributes` (16 байт, если `offset_attributes != 0`):**

    ```cpp
    struct mh2o_chunk_attributes { // 16 байт
        uint64_t fishable;    // Битовая маска 8x8: можно ли ловить рыбу / видимость.
        uint64_t deep;        // Битовая маска 8x8: глубокая вода / зона усталости.
    };
    ```

* **Структура `SMLiquidInstance` (24 байта для WotLK, описывает один слой/прямоугольник жидкости):**

    ```cpp
    struct SMLiquidInstance_WotLK { // 24 байта
        uint16_t liquid_type;         // ID типа жидкости (ссылка на LiquidType.dbc).
        uint16_t LVF;                 // LiquidVertexFormat: формат данных вершин (0-3).
        float    min_height_level;    // Мин. уровень высоты (используется если нет карты высот / для culling).
        float    max_height_level;    // Макс. уровень высоты (для LVF=2 обычно игнорируется, высота 0.0).
        uint8_t  x_offset;            // Смещение по X (0-7) прямоугольника жидкости внутри MCNK.
        uint8_t  y_offset;            // Смещение по Y (0-7) прямоугольника жидкости внутри MCNK.
        uint8_t  width;               // Ширина (1-8) прямоугольника жидкости.
        uint8_t  height;              // Высота (1-8) прямоугольника жидкости.
        uint32_t offset_exists_bitmap;// Относительное смещение к битовой маске видимости тайлов (размер (width*height+7)/8). 0 = все существуют.
        uint32_t offset_vertex_data;  // Относительное смещение к данным вершин. 0 и liquidType!=2 => LVF=2.
    };
    ```

* **Данные вершин (`instance_vertex_data`):** (Структура уточняется)
  * Располагаются по смещению `offset_vertex_data`.
  * Количество вершин: `(width + 1) * (height + 1)`.
  * Формат зависит от `LVF`:
    * **Case 0 (Height & Depth):** `float heightmap[]`, `uint8_t depthmap[]`
    * **Case 1 (Height & UV):** `float heightmap[]`, `struct {uint16_t u, v;} uvmap[]`
    * **Case 2 (Depth only):** `uint8_t depthmap[]` (высота всегда 0.0)
    * **Case 3 (Height, UV, Depth):** `float heightmap[]`, `struct {uint16_t u, v;} uvmap[]`, `uint8_t depthmap[]`
  * Чтение и интерпретация этих данных требует аккуратного вычисления размеров на основе `LVF`, `width`, `height` и анализа смежных блоков данных.

* **Анализ (предварительный):**
  * Файлы ADT Нордскола часто содержат `MH2O` чанк для описания обширных водных пространств.
  * Большинство жидкостей в Нордсколе (например, океан) используют `liquid_type = 2` и `LVF = 2` (только глубина, высота 0.0).
  * Смещения к различным блокам данных (`SMLiquidInstance`, атрибуты, битмапы, вершины) обычно указывают на плотно упакованные данные, следующие друг за другом после массива `SMLiquidChunk`.

Далее следует описание чанков `MCNK` и их под-чанков.

## 12. MFBO (Map Flight Boundary Obstacles) Chunk

* **Расположение:** Смещение к чанку `MFBO` указывается полем `offsetMFBO` в данных чанка `MHDR`. Чанк присутствует, если установлен флаг `mhdr_MFBO` (бит 0) в поле `MHDR.flags`. Абсолютное смещение `MFBO` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMFBO_из_данных_MHDR>`. Если флаг не установлен, `offsetMFBO` в `MHDR` равен 0, и чанк отсутствует.

* **Назначение:** Содержит данные, предположительно определяющие границы или препятствия для полетов над данной территорией ADT. Это могут быть максимальные и минимальные высоты для некоторой сетки регионов на карте.

* **Структура заголовка MFBO (8 байт):**
  * **Идентификатор чанка (Chunk ID):** 4 байта. В коде `MFBO`, в файле хранится как `OBFM`.
  * **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Для WotLK 3.3.5a, на основе анализа, это значение всегда `36` байт.

* **Данные чанка (Chunk Data):** Последовательность данных размером 36 байт, представляющая две матрицы 3x3 значений высот.

    ```cpp
    struct MFBO_Data_WotLK { // 36 байт
        int16_t maximum_plane[3][3]; // Матрица 3x3 максимальных высот
        int16_t minimum_plane[3][3]; // Матрица 3x3 минимальных высот
    }; // Размер данных = (9 * 2_байта) + (9 * 2_байта) = 18 + 18 = 36 байт
    ```

  * `maximum_plane`: 9 значений `int16_t`, представляющих максимальные высоты для сетки 3x3 регионов.
  * `minimum_plane`: 9 значений `int16_t`, представляющих минимальные высоты для той же сетки 3x3 регионов.

* **Интерпретация полей (на основе анализа вывода парсера):**
  * Каждая из двух матриц (`maximum_plane` и `minimum_plane`) описывает высоты для условной сетки 3x3, покрывающей тайл ADT.
  * Значения хранятся как `int16_t`.
  * Часто встречающиеся значения, такие как `1000`, `-1000`, `-2000`, вероятно, являются некими стандартными или "безграничными" значениями, указывающими на отсутствие явных ограничений по высоте (например, открытое небо или очень глубокие области).
  * Более конкретные значения (например, `104`, `105`, `205`) представляют собой реальные рассчитанные границы высот для соответствующих участков карты.

* **Анализ и особенности MFBO в WotLK 3.3.5a:**
  * Чанк `MFBO` используется не во всех ADT файлах. Его наличие контролируется флагом `mhdr_MFBO` в `MHDR.flags`.
  * В файлах `Northrend_*.adt` (карты открытого мира Нордскола) чанк `MFBO` часто присутствует и содержит данные.
  * В файлах `RazorfenDowns_*.adt` (подземелье) флаг `mhdr_MFBO` не установлен, и чанк `MFBO` отсутствует. Это логично, так как в закрытых локациях такая информация может быть излишней или обрабатываться иначе.
  * Данные из `MFBO` могут использоваться для оптимизации рендеринга (flight culling), определения границ для полетов или для общей навигации воздушных юнитов.

## 13. MTXF (Map Texture Flags) Chunk

* **Расположение:** Смещение к чанку `MTXF` указывается полем `offsetMTXF` в данных чанка `MHDR`. Абсолютное смещение `MTXF` чанка рассчитывается как: `<абсолютное_смещение_начала_блока_данных_MHDR (0x14)> + <значение_поля_offsetMTXF_из_данных_MHDR>`.
* **Назначение:** Предназначен для хранения флагов для текстур, перечисленных в чанке `MTEX`. Каждый флаг представляет собой 4-байтное значение. Количество флагов должно совпадать с количеством текстур в `MTEX`.
* **Структура (WotLK):**

    ```cpp
    struct SMTextureFlags_WotLK { // 4 байта
        uint32_t do_not_load_specular_or_height_texture_but_use_cubemap : 1;
        uint32_t _reserved : 31; // Остальные биты в WotLK обычно не используются или равны 0
    };
    ```

* **Анализ и особенности MTXF в WotLK 3.3.5a:**
  * Поле `offsetMTXF` в `MHDR` для всех проанализированных файлов WotLK 3.3.5a было равно `0`.
  * Это указывает на то, что чанк `MTXF` в этих файлах отсутствует и не используется. Его основное применение, вероятно, относится к более поздним версиям игры или очень специфическим случаям.

## 14. MCNK (Map Chunk) Chunks and Sub-chunks

* **Расположение:** После глобальных чанков (таких как `MVER`, `MHDR`, `MCIN`, `MTEX`, `MMDX`, `MMID`, `MWMO`, `MWID`, `MDDF`, `MODF`, `MFBO`, `MH2O`, `MTXF`) следует блок данных, состоящий из 256 `MCNK` чанков. Информация о смещении и размере каждого из 256 `MCNK` чанков содержится в чанке `MCIN`.

* **Назначение:** Каждый `MCNK` чанк представляет собой один квадратный участок карты размером примерно 33.33x33.33 ярда (100/3 ярдов). Он содержит всю детальную информацию о ландшафте этого участка, включая высоты, нормали, текстурные слои, размещение мелких объектов (doodads), воду, дыры в ландшафте и т.д. ADT файл представляет собой сетку 16x16 таких `MCNK` чанков.

* **Общая структура MCNK чанка:**
    1. **Заголовок `MCNK` (8 байт):**
        * `char[4] chunk_id`: Идентификатор чанка (`MCNK`, в файле как `KNCM`).
        * `uint32_t chunk_data_size`: Размер данных `MCNK`, следующих *после* этого поля (т.е., не включая ID и поле размера). Этот размер включает 128-байтный заголовок `MCNK` и все его под-чанки.
    2. **Заголовок данных `MCNK` (128 байт):** Сразу после 8-байтового заголовка чанка следует 128-байтный блок с основной информацией и смещениями к под-чанкам. Смещения к под-чанкам, указанные в этом заголовке, являются **относительными от начала самого `MCNK` чанка** (т.е. от `chunk_id` этого `MCNK`).
    3. **Под-чанки `MCNK`:** Набор различных под-чанков (`MCVT`, `MCNR`, `MCLY`, `MCAL`, `MCSH`, `MCRF`, `MCSE`, `MCLQ`, `MCCV`), содержащих специфические данные для этого участка карты. Порядок и наличие этих под-чанков определяется информацией из 128-байтного заголовка `MCNK`.

* **Структура 128-байтного заголовка данных `MCNK` (WotLK 3.3.5a, на основе анализа и wowdev.wiki):**

    ```cpp
    struct MCNK_Header_WotLK { // 128 байт
        // --- Основная информация и флаги (0x00 - 0x0F) ---
        uint32_t flags;             // 0x00: Флаги чанка (см. ниже)
        uint32_t indexX;            // 0x04: Индекс X этого MCNK в сетке ADT (0-15)
        uint32_t indexY;            // 0x08: Индекс Y этого MCNK в сетке ADT (0-15)
        uint32_t nLayers;           // 0x0C: Количество текстурных слоев (MCLY), максимум 4
        
        // --- Ссылки и счетчики (0x10 - 0x1B) ---
        uint32_t nDoodadRefs;       // 0x10: Количество ссылок на дудады в MCRF (для этого MCNK)
        uint32_t ofsHeight;         // 0x14: Смещение к MCVT (данные вершин)
        uint32_t ofsNormal;         // 0x18: Смещение к MCNR (данные нормалей)
        uint32_t ofsLayer;          // 0x1C: Смещение к MCLY (информация о текстурных слоях)
        
        // --- Ссылки на объекты и альфа-канал (0x20 - 0x2F) ---
        uint32_t ofsRefs;           // 0x20: Смещение к MCRF (ссылки на M2/WMO)
        uint32_t ofsAlpha;          // 0x24: Смещение к MCAL (альфа-карты для текстур)
        uint32_t sizeAlpha;         // 0x28: Размер данных MCAL
        uint32_t ofsShadow;         // 0x2C: Смещение к MCSH (карта теней), если флаг flags.has_mcsh
        
        // --- Тени, AreaID, Объекты (0x30 - 0x3F) ---
        uint32_t sizeShadow;        // 0x30: Размер данных MCSH
        uint32_t areaid;            // 0x34: ID зоны/подзоны (старшие 2 байта - зона, младшие - подзона)
        uint32_t nMapObjRefs;       // 0x38: Количество ссылок на WMO в MCRF (для этого MCNK)
        uint16_t holes_low_res;     // 0x3C: Битовая маска "дыр" в ландшафте (для старых версий, 8x8 сетка)
        uint16_t unknown_padding_0x3E; // 0x3E: (наверное) Выравнивание или неиспользуемое поле, часто 0 или 1.

        // --- Карта низкокачественных текстур и эффектов (0x40 - 0x5F) ---
        // Это поле размером 16 байт, где каждые 2 бита кодируют индекс текстуры для ячейки 8х8.
        // (наверное) 4 значения (по 2 бита) упакованы в 1 байт. Всего 8*8 = 64 значения.
        unsigned char  reallyLowQualityTextureingMap[16]; // 0x40: Карта текстур очень низкого качества (16 байт = 8x8 * 2 бита)
        // Это поле размером 8 байт, где каждый бит кодирует флаг для ячейки 8х8.
        // (наверное) 8 значений (по 1 биту) упакованы в 1 байт. Всего 8*8 = 64 значения.
        unsigned char  noEffectDoodad[8];                 // 0x50: Карта запрета эффектов для дудадов (8 байт = 8x8 * 1 бит)
        uint32_t ofsMCSE;           // 0x58: Смещение к MCSE (звуковые эмиттеры)
        uint32_t numMCSE;           // 0x5C: Количество записей в MCSE

        // --- Данные о жидкости и позиция (0x60 - 0x77) ---
        uint32_t ofsMCLQ;           // 0x60: Смещение к MCLQ (данные о жидкости в чанке, если не используется глобальный MH2O)
        uint32_t sizeMCLQ;          // 0x64: Размер данных MCLQ (может быть 0, если нет локальной жидкости)
        float    zpos;              // 0x68: Координата Y центра чанка (мировые координаты WoW, Z-up)
        float    xpos;              // 0x6C: Координата X центра чанка (мировые координаты WoW, Z-up)
        float    ypos;              // 0x70: Координата Z (ВЫСОТА) центра чанка (мировые координаты WoW, Z-up)
                                    // (ВАЖНЕЙШЕЕ ПРИМЕЧАНИЕ ПО КООРДИНАТАМ: Порядок полей в файле: zpos, xpos, ypos.
                                    //  Они соответствуют мировым координатам WoW следующим образом:
                                    //  - Поле `xpos` из файла -> мировая координата X.
                                    //  - Поле `zpos` из файла -> мировая координата Y.
                                    //  - Поле `ypos` из файла -> мировая координата Z (ВЫСОТА).
                                    //  Эта неочевидная схема является ключом к правильному воссозданию геометрии.)
        uint32_t textureIdOrMCCV;   // 0x74: Если флаг flags.has_mccv не установлен, это textureId для MCAL (?). 
                                    //         Если флаг flags.has_mccv установлен, это (наверное) смещение к MCCV или флаг его наличия.
                                    //         В WotLK, если MCCV есть, это поле часто 0, а MCCV идет сразу после MCNR.
                                    //         Требует дополнительного исследования для WotLK.
        // --- Разное (0x78 - 0x7F) ---
        uint32_t props;             // 0x78: (наверное) Свойства чанка, часто 0.
        uint32_t effectId;          // 0x7C: (наверное) ID эффекта, часто 0.
    }; // Общий размер 128 байт (0x80)
    ```

* **Ключевой момент: Расчет координат ландшафта**
  
  Самое важное для понимания: заголовок `MCNK` уже содержит **готовые абсолютные мировые координаты центра этого чанка**. Их не нужно дополнительно преобразовывать или рассчитывать из имени ADT файла.
  
  * **Мировая X-координата центра чанка** берется из поля `xpos` (смещение 0x6C).
  * **Мировая Y-координата центра чанка** берется из поля `zpos` (смещение 0x68).
  * **Мировая Z-координата (высота) центра чанка** берется из поля `ypos` (смещение 0x70).

  Все вершины ландшафта из под-чанка `MCVT` являются лишь относительными смещениями по высоте от этой базовой высоты (`ypos`).

* **Основные флаги `MCNK_Header_WotLK.flags` (поле `flags`):**
  * `0x00000001 (has_mcsh)`: Указывает на наличие под-чанка `MCSH` (тени).
  * `0x00000002 (impass)`: Участок непроходим.
  * `0x00000004 (lq_river)`: Жидкость типа "река" (низкое качество).
  * `0x00000008 (lq_ocean)`: Жидкость типа "океан" (низкое качество).
  * `0x00000010 (lq_magma)`: Жидкость типа "магма" (низкое качество).
  * `0x00000020 (lq_slime)`: Жидкость типа "слизь" (низкое качество).
  * `0x00000040 (has_mccv)`: Указывает на наличие под-чанка `MCCV` (цвета вершин), если он есть, то поле `textureIdOrMCCV` (0x74) может интерпретироваться иначе или не использоваться.
  * `0x00008000 (do_not_fix_alpha_map)`: Не применять исправление для альфа-карт (касается формата 4444).
  * `0x00010000 (high_res_holes)`: (Более поздние версии) Использовать 64-битную маску для "дыр" вместо `holes_low_res`. В WotLK этот флаг, (наверное), не используется активно.

* **Анализ и особенности MCNK в WotLK 3.3.5a:**
  * Заголовок `MCNK` всегда 128 байт.
  * Координаты `xpos, ypos, zpos` в заголовке представляют собой мировые координаты центра данного `MCNK` чанка.
  * Смещения к под-чанкам (`ofsHeight`, `ofsNormal` и т.д.) всегда относительны начала самого `MCNK` чанка.
  * Если смещение к под-чанку равно 0, то этот под-чанк отсутствует или не используется (например, `ofsShadow` если флаг `has_mcsh` не установлен).
  * Содержимое `reallyLowQualityTextureingMap` (16 байт) и `noEffectDoodad` (8 байт) требует специальной распаковки битовых полей для получения данных по каждой из 64 ячеек (8x8) внутри MCNK.

* **Предстоящие подпункты для MCNK:**
  * 14.1. `MCVT` (Map Chunk Vertex Table) - Данные о высотах вершин.
  * 14.2. `MCNR` (Map Chunk Normals) - Данные о нормалях вершин.
  * 14.3. `MCLY` (Map Chunk Layer) - Информация о текстурных слоях.
  * 14.4. `MCRF` (Map Chunk References) - Ссылки на M2 модели (doodads) и WMO.
  * 14.5. `MCAL` (Map Chunk Alpha Layer) - Альфа-карты для смешивания текстур.
  * 14.6. `MCSH` (Map Chunk Shadow) - Карты теней.
  * 14.7. `MCSE` (Map Chunk Sound Emitters) - Размещение звуковых эмиттеров.
  * 14.8. `MCLQ` (Map Chunk Liquid) - Данные о жидкости (если не используется MH2O).
  * 14.9. `MCCV` (Map Chunk Vertex Colors) - Цвета вершин (редко используется).
  * (Другие возможные под-чанки, если будут обнаружены)

### 14.1. MCVT (Map Chunk Vertex Table) - Данные о высотах вершин

* **Расположение:** Смещение к под-чанку `MCVT` указывается полем `ofsHeight` (0x14) в 128-байтном заголовке данных `MCNK`.
* **Назначение:** Содержит 145 значений `float`, которые являются **относительными смещениями по высоте** для вершин данного `MCNK` чанка.
* **Структура:** Заголовок `MCVT` (8 байт) и данные (580 байт).
* **Расчет абсолютных координат вершин:**
  Для получения итоговых мировых координат (X, Y, Z) каждой вершины необходимо:
  1. Взять **базовые мировые координаты центра чанка** из заголовка `MCNK` (`xpos`, `zpos`, `ypos`).
  2. Взять **относительную высоту** `height_value` из `MCVT` для текущей вершины.
  3. Рассчитать **локальные смещения вершины (local_x, local_y)** внутри сетки чанка.

  **Формулы:**
  * `center_x = MCNK.xpos`
  * `center_y = MCNK.zpos`
  * `center_z = MCNK.ypos`
  * `corner_x = center_x - (MCNK_SIZE_UNITS / 2.0)` (северо-восточный угол)
  * `corner_y = center_y - (MCNK_SIZE_UNITS / 2.0)` (северо-восточный угол)

  **Для внешних вершин (9x9 сетка, i - колонка, j - ряд):**
  * `abs_x = corner_x + (i * UNIT_SIZE)`
  * `abs_y = corner_y + (j * UNIT_SIZE)`
  * `abs_z = center_z + height_value` (где `height_value` из `MCVT[j * 9 + i]`)

  **Для внутренних вершин (8x8 сетка, i - колонка, j - ряд):**
  * `abs_x = corner_x + (i * UNIT_SIZE + UNIT_SIZE / 2.0)`
  * `abs_y = corner_y + (j * UNIT_SIZE + UNIT_SIZE / 2.0)`
  * `abs_z = center_z + height_value` (где `height_value` из `MCVT[81 + j * 8 + i]`)

* **Анализ и особенности MCVT в WotLK 3.3.5a:**
  * Под-чанк `MCVT` является фундаментальным для определения геометрии ландшафта.
  * Координатная система WoW - Z-up (ось Z направлена вверх).
  * **Важно:** Для корректного отображения ландшафта в World of Warcraft (и совпадения с in-game геометрией) необходимо:
    1. Инвертировать X-координату: `x = -x`.
    2. Повернуть результат на 270 градусов против часовой стрелки:
       * `newX = x * cos(270°) - y * sin(270°)`
       * `newY = x * sin(270°) + y * cos(270°)`
    3. Z-координата не меняется.

### 14.2. MCNR (Map Chunk Normals) - Данные о нормалях вершин

* **Расположение:** Смещение к под-чанку `MCNR` указывается полем `ofsNormal` (0x18) в 128-байтном заголовке данных `MCNK`. Смещение является относительным от начала `MCNK` чанка. Если `ofsNormal` равно 0, под-чанк `MCNR` отсутствует (хотя на практике он обычно присутствует, если есть `MCVT`).
* **Назначение:** Содержит данные о нормалях для каждой из 145 вершин (81 внешней и 64 внутренних), определенных в `MCVT`. Нормали необходимы для корректного расчета освещения и затенения ландшафта.
* **Структура заголовка MCNR (8 байт):
  * `char[4] chunk_id`: Идентификатор под-чанка (`MCNR`, в файле как `RNCM`).
  * `uint32_t chunk_data_size`: Размер данных `MCNR`, следующих за этим полем. Для WotLK 3.3.5a это **всегда 435 байт** (145 нормалей *3 компонента/нормаль* 1 байт/компонент).
* **Данные под-чанка MCNR (435 байт):
  * Представляет собой массив из 145 записей, где каждая запись - это 3 компонента вектора нормали.
  * **Формат одной нормали:** `struct { int8_t normal_x; int8_t normal_z; int8_t normal_y; }`. Обратите внимание на порядок: X, Z, Y, как указано на wowdev.wiki.
    * `normal_x`: компонента X нормали.
    * `normal_z`: компонента Z нормали (в этой системе координат нормали, Z часто интерпретируется как направление "вверх" от поверхности).
    * `normal_y`: компонента Y нормали.
  * Каждый компонент (`int8_t`) является знаковым 8-битным целым числом. Значения нормализованы: `127` соответствует `1.0`, а `-127` соответствует `-1.0` при преобразовании в числа с плавающей запятой.
  * Общий размер данных: `145 * 3 = 435` байт.
  * **Padding (Заполнение):** В WotLK 3.3.5a чанк `MCNR` имеет размер 435 байт и не включает дополнительное 13-байтовое заполнение, которое упоминается в документации для более поздних версий (например, Cataclysm), где размер чанка может быть 448 байт.

* **Интерпретация и преобразование нормалей:**
  * Для использования в мировой системе координат WoW (Z-up, где X и Y - горизонтальные оси, а Z - вертикальная высота), компоненты из файла нужно интерпретировать и, возможно, преобразовывать.
  * Исходя из `normal_x, normal_z, normal_y` из файла:
    * Мировая X нормали (`world_nx`) обычно берется из `normal_x`.
    * Мировая Y нормали (`world_ny`) обычно берется из `normal_y`.
    * Мировая Z нормали (`world_nz`, направление "вверх") обычно берется из `normal_z`.
  * Преобразование в float: `component_float = component_int8 / 127.0`.

* **Анализ и особенности MCNR в WotLK 3.3.5a:**
  * Под-чанк `MCNR` почти всегда присутствует вместе с `MCVT`.
  * Данные в `MCNR` напрямую соответствуют 145 вершинам из `MCVT`.
  * Наблюдались случаи (например, на плоских участках в Karazhan), где "сырые" данные нормалей из файла (например, `normal_x=0, normal_z=0, normal_y=127`) приводят к мировым нормалям вида `(0.0, 1.0, 0.0)`. В Z-up системе это вектор, направленный вдоль оси Y, а не строго вверх `(0.0, 0.0, 1.0)`. Это может быть особенностью данных в файлах или требовать более детального изучения того, как клиент игры их окончательно использует.
  * В документации wowdev.wiki упоминается, что Z-компонента нормали (в их описании это `normal[1]`, что соответствует `normal_z` здесь) всегда положительна (направлена вверх/наружу).

### 14.3. MCRF (Map Chunk References) - Ссылки на M2 и WMO

* **Расположение:** Смещение к под-чанку `MCRF` указывается полем `ofsRefs` (смещение 0x20 от начала 128-байтного заголовка `MCNK`) в заголовке `MCNK`. Смещение является относительным от начала самого `MCNK` чанка (т.е. от его `chunk_id`). `MCRF` может отсутствовать (если `ofsRefs == 0`).
* **Назначение:** Содержит списки индексов, которые ссылаются на записи в глобальных чанках ADT файла: `MDDF` (для M2 моделей/дудадов) и `MODF` (для WMO/объектов карты). Эти ссылки определяют, какие конкретно дудады и объекты карты, глобально определенные для всего ADT-тайла, должны быть отображены и учтены для коллизий в данном конкретном `MCNK` чанке.
* **Структура заголовка MCRF (8 байт):**
  * `char[4] chunk_id`: Идентификатор под-чанка (`MCRF`, в файле хранится как `FRCM`).
  * `uint32_t chunk_data_size`: Размер данных `MCRF`, следующих за этим полем. Этот размер должен быть равен `(nDoodadRefs_from_MCNK_header + nMapObjRefs_from_MCNK_header) * 4` байта.
* **Данные под-чанка MCRF:**
  * Сначала идет массив из `nDoodadRefs` (значение из заголовка `MCNK`) 4-байтовых целых чисел (`uint32_t`). Каждое значение – это 0-индексированная ссылка на запись в чанке `MDDF`.
  * Сразу за ним следует массив из `nMapObjRefs` (значение из заголовка `MCNK`) 4-байтовых целых чисел (`uint32_t`). Каждое значение – это 0-индексированная ссылка на запись в чанке `MODF`.
  * Общее количество ссылок: `nDoodadRefs + nMapObjRefs`.
  * Общий размер данных: `(nDoodadRefs + nMapObjRefs) * sizeof(uint32_t)`.

    ```cpp
    // Концептуальная структура данных MCRF
    struct MCRF_Data_WotLK {
        uint32_t doodad_refs[MCNK_Header.nDoodadRefs]; // Индексы в MDDF
        uint32_t object_refs[MCNK_Header.nMapObjRefs]; // Индексы в MODF
    };
    ```

* **Важность для NavMesh:** `MCRF` критически важен. Он позволяет точно определить, какие M2 и WMO объекты (препятствия) присутствуют в каждом `MCNK`. Без `MCRF` невозможно корректно воссоздать геометрию мира для генерации NavMesh, так как пришлось бы либо игнорировать все объекты, либо ошибочно считать все глобальные объекты (`MDDF`/`MODF`) присутствующими в каждом `MCNK`.
* **Анализ в WotLK 3.3.5a (на основе `adt_parser.py`):**
  * Парсер успешно извлекает списки `doodad_refs` и `object_refs`.
  * Во многих `MCNK` (например, в файле `Karazahn_30_33.adt` из логов) `nMapObjRefs` часто равно 0, и `MCRF` содержит только ссылки на дудады (`doodad_refs`). В файле `ZulAman_31_33.adt` также наблюдается преобладание `doodad_refs`.
  * Если `nDoodadRefs` и `nMapObjRefs` оба равны 0 в заголовке `MCNK`, то `ofsRefs` также обычно 0, и под-чанк `MCRF` отсутствует, или его `chunk_data_size` равен 0 (что было видно в логах для `ZulAman_31_33.adt` для многих MCNK).
  * Размер данных, указанный в заголовке `MCRF`, соответствует ожидаемому размеру, рассчитанному из `nDoodadRefs` и `nMapObjRefs` из заголовка `MCNK`.
  * Клиент игры использует эти ссылки для определения, какие объекты отрисовывать и с какими объектами проверять коллизии для игрока, находящегося в данном `MCNK`.
* **Замечание по версии Cataclysm:** В Cataclysm и более поздних версиях `MCRF` разделен на `MCRD` (для дудадов) и `MCRW` (для WMO). В WotLK 3.3.5a используется единый `MCRF`.
