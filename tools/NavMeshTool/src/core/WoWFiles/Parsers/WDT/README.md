# WDT File Format Parser

Этот модуль отвечает за чтение и интерпретацию данных из файлов `.wdt` World of Warcraft.

## Источник информации о формате

Основная спецификация формата WDT взята с [wowdev.wiki - WDT page](https://wowdev.wiki/WDT).

## Обзор структуры WDT

WDT файлы определяют, какие тайлы карты (`.adt`) присутствуют в игровом мире, и могут также ссылаться на "глобальный" WMO. Файлы имеют чанковую структуру. Каждый чанк начинается с 4-байтного идентификатора (сигнатуры) и 4-байтного размера данных чанка.

### Основные чанки (актуально для WotLK 3.3.5a)

Для версии 3.3.5a наиболее важными являются следующие чанки:

1. MVER (Map Version)

* **ID в файле**: `REVM` (читается как "MVER")
* **Общий размер чанка в примере**: 12 байт (8+4).
* **Структура чанка**:
    1. **Идентификатор чанка (4 байта)**: "REVM" (ASCII), что в little-endian соответствует "MVER".
    2. **Размер данных чанка (4 байта)**: Указывает, сколько байт занимают *непосредственно данные* этого чанка (следующее поле).
    3. **Данные чанка (N байт)**: Сами данные, специфичные для этого чанка.

* **Пример разбора 12 байт чанка MVER:** `5245564d 04000000 12000000`

  * **`5245564d`** (первые 4 байта):
    * ASCII: "REVM"
    * Интерпретация: Идентификатор чанка **"MVER"** (Map VERsion). Байты 'M', 'V', 'E', 'R' записаны в обратном порядке из-за little-endian.

  * **`04000000`** (следующие 4 байта):
    * Hex (little-endian): `04 00 00 00`
    * Hex (big-endian): `00 00 00 04`
    * Десятичное значение: `4`
    * Интерпретация: Это **размер данных** чанка MVER. Означает, что следующие 4 байта содержат фактические данные версии. Это значение *не* включает 4 байта ID и 4 байта самого этого поля размера.

  * **`12000000`** (последние 4 байта из этого примера):
    * Hex (little-endian): `12 00 00 00`
    * Hex (big-endian): `00 00 00 12`
    * Десятичное значение: `18`
    * Интерпретация: Это **данные** чанка MVER, которые представляют собой версию формата файла WDT. В данном случае, версия `18`.

    Таким образом, весь чанк MVER (`REVM <размер_данных_4_байта> <данные_версии_18>`) занимает 12 байт.

1. **`MPHD` (Map Header)**
    * **ID в файле**: `DHPM` (читается как "MPHD")
    * **Общий размер чанка в примере**: 40 байт (8 байт заголовок + 32 байта данных).
    * **Структура чанка (общая)**:
        1. **Идентификатор чанка (4 байта)**: "DHPM" (ASCII), что в little-endian соответствует "MPHD".
        2. **Размер данных чанка (4 байта)**: Указывает, сколько байт занимают *непосредственно данные* этого чанка.
        3. **Данные чанка (N байт)**: Сами данные, специфичные для MPHD.

    * **Пример разбора 40 байт чанка MPHD:** `4448504d 20000000 0000000000000000000000000000000000000000000000000000000000000000`
        * **`4448504d`** (первые 4 байта):
            * ASCII: "DHPM"
            * Интерпретация: Идентификатор чанка **"MPHD"** (Map Properties HeaDer). Байты 'M', 'P', 'H', 'D' записаны в обратном порядке.

        * **`20000000`** (следующие 4 байта):
            * Hex (little-endian): `20 00 00 00`
            * Hex (big-endian): `00 00 00 20`
            * Десятичное значение: `32`
            * Интерпретация: Это **размер данных** чанка MPHD. Означает, что следующие 32 байта содержат фактические данные MPHD.

        * **`0000000000000000000000000000000000000000000000000000000000000000`** (следующие 32 байта):
            * Интерпретация: Это **данные** чанка MPHD. В данном конкретном примере все 32 байта данных равны нулю. Эти байты соответствуют структуре `MPHDChunk`:
                * `flags` (4 байта): `00000000` (значение 0)
                * `wdtEntryId` (4 байта): `00000000` (значение 0)
                * `unused[0]` (4 байта): `00000000` (значение 0)
                * `unused[1]` (4 байта): `00000000` (значение 0)
                * `unused[2]` (4 байта): `00000000` (значение 0)
                * `unused[3]` (4 байта): `00000000` (значение 0)
                * `unused[4]` (4 байта): `00000000` (значение 0)
                * `unused[5]` (4 байта): `00000000` (значение 0)

    * Размер: 32 байта (8 x `uint32_t`).
    * Содержит глобальные флаги и информацию для карты.
    * Структура (примерно для 3.3.5a):

        ```cpp
        struct MPHDChunk {
            uint32_t flags;
            uint32_t wdtEntryId; // ID записи этого WDT в DBC (например, Map.dbc)
            uint32_t unused[6]; // Остальные поля в WotLK, похоже, не используются или их назначение не до конца ясно из wowdev для этой версии.
        };
        ```

    * **Основные флаги (`flags`):**
        * `0x1` (`wdt_uses_global_map_obj`): Указывает, что карта использует глобальный WMO, определенный в чанках `MWMO` и `MODF`.
        * `0x2` (`adt_has_mccv`): Если установлен, все ADT на этой карте должны иметь `MCCV` чанк (цвета вершин).
        * `0x4` (`adt_has_big_alpha`): Влияет на используемые шейдеры ландшафта.
        * `0x80` (`adt_has_height_texturing`): Влияет на альфа-карты высот.

2. **`MAIN` (Map Area Information)**
    * **ID в файле**: `NIAM` (читается как "MAIN")
    * **Общий размер чанка в примере (только заголовок)**: 8 байт для заголовка, за которым следуют данные.
    * **Размер данных (согласно заголовку в примере)**: 32768 байт.
    * **Структура чанка (общая)**:
        1. **Идентификатор чанка (4 байта)**: "NIAM" (ASCII), что в little-endian соответствует "MAIN".
        2. **Размер данных чанка (4 байта)**: Указывает, сколько байт занимают *непосредственно данные* этого чанка (в данном случае, 32768 байт).
        3. **Данные чанка (N байт)**: Последовательность из 4096 записей `SMAreaInfo`, по одной для каждого тайла карты 64x64.

    * **Пример заголовка чанка MAIN:** `4e49414d 00800000`
        * **`4e49414d`** (первые 4 байта):
            * ASCII: "NIAM"
            * Интерпретация: Идентификатор чанка **"MAIN"**.

        * **`00800000`** (следующие 4 байта):
            * Hex (little-endian): `00 80 00 00`
            * Hex (big-endian): `00 00 80 00`
            * Десятичное значение: `32768`
            * Интерпретация: Это **размер данных** чанка MAIN. Означает, что следующие 32768 байт содержат информацию о тайлах.

    * **Структура данных чанка MAIN (32768 байт):**
        * Состоит из `64 * 64 = 4096` последовательных записей.
        * Каждая запись имеет размер 8 байт и соответствует структуре `SMAreaInfo`:

            ```cpp
            struct SMAreaInfo { // 8 байт
                uint32_t flags;    // Поле флагов (4 байта). Бит 0 (0x1) означает наличие ADT.
                uint32_t asyncId;  // Обычно 0 в файле (4 байта).
            };
            ```

        * Таким образом, данные чанка MAIN можно представить как: `[SMAreaInfo_0_0, SMAreaInfo_0_1, ..., SMAAreaInfo_0_63, SMAAreaInfo_1_0, ..., SMAAreaInfo_63_63]`.
        * Если `SMAreaInfo.flags & 0x1` истинно для какой-либо записи, это означает, что соответствующий ADT файл (например, `MapName_XX_YY.adt`, где координаты XX и YY определяются ниже) существует.

    * **Определение координат ADT (XX_YY) из смещения в файле:**
        Для WDT файла, где чанки MVER, MPHD и заголовок MAIN идут последовательно перед данными MAIN:
        1. **Начало данных чанка MAIN**: В стандартном WDT с MVER (12 байт) и MPHD (40 байт), данные MAIN начинаются после заголовка MAIN (8 байт), то есть с абсолютного смещения `12 + 40 + 8 = 60` (или `0x3C`) байт от начала файла.
        2. Пусть `abs_file_offset` - это абсолютное смещение в файле до начала 8-байтной записи `SMAreaInfo`.
        3. **Смещение внутри данных MAIN**: `offset_in_main_data = abs_file_offset - 0x3C`.
        4. **0-индекс записи `SMAreaInfo`**: `index = offset_in_main_data / 8`. Этот индекс будет от 0 до 4095.
        5. **Координаты для файла `MapName_XX_YY.adt`**:
            * `XX = index % 64`
            * `YY = index / 64` (целочисленное деление)
            (Примечание: `XX` соответствует столбцу, `YY` - строке, оба от 0 до 63).

3. **`MWMO` (Map World Map Object)** (Опциональный)
    * Присутствует, если в `MPHD` установлен флаг `wdt_uses_global_map_obj`.
    * Список имен файлов WMO, используемых на карте как глобальные объекты. Это просто большой блок с путями к WMO файлам, разделенными нулевыми символами.

4. **`MODF` (Map Object Definition Flags)** (Опциональный)
    * Присутствует, если в `MPHD` установлен флаг `wdt_uses_global_map_obj`.
    * Определяет размещение и свойства для каждого WMO, указанного в `MWMO`.
    * Структура записи:

        ```cpp
        struct MODFEntry {
            uint32_t nameId;        // Индекс имени WMO в чанке MWMO (не прямой fileDataId в 3.3.5a). Это скорее всего смещение в MWMO блоке.
            uint32_t uniqueId;      // Уникальный ID для этого экземпляра WMO.
            float position[3];    // X, Y, Z координаты.
            float orientation[3]; // Поворот в градусах по осям X, Y, Z.
            float extents[6];     // AABB (Axis-Aligned Bounding Box) - minX, minY, minZ, maxX, maxY, maxZ.
            uint16_t flags;         // Флаги (например, `0x1` - использовать геометрию из `extents`).
            uint16_t doodadSet;     // Индекс набора MMDX/MMDD (декораций) для этого WMO.
            uint32_t nameSet;       // Имя набора, обычно 0.
            uint32_t scale;         // Масштаб. (Добавлено в BfA, в 3.3.5a тут может быть что-то другое или нули. Wowdev указывает это как `uint32_t scale; // new in BFA: only for some WMOs (does not apply to all WMOs with MODF entries). This field is only read if CMap::isBeforeBFA returns false. Needs to be 1024 for no scaling.`). Для 3.3.5a это поле, скорее всего, просто часть данных, которые нужно прочитать, но его интерпретация как `scale` может быть неверной. Часто это поле просто 0.
        };
        ```

        *Важно: Поле `scale` в `MODFEntry` было добавлено/изменено в BfA. Для 3.3.5a оно, вероятно, является частью структуры, но может не интерпретироваться как масштаб, или быть просто нулями/неиспользуемым. Нам нужно будет аккуратно парсить его как `uint32_t`.*

### Прочие чанки

WDT файлы могут содержать и другие чанки (например, `MAID`, `_occ`, `_lgt`, `_fogs`, `_mpv`), но многие из них были добавлены в более поздних дополнениях (Cataclysm, Legion, BfA и далее) или используются для специфических эффектов, которые могут быть не критичны для базового парсинга геометрии навигационной сетки. Для начала мы сосредоточимся на `MVER`, `MPHD`, `MAIN`, `MWMO` и `MODF`.

## Процесс парсинга

1. Прочитать заголовок файла (MVER).
2. Последовательно читать чанки:
    * Прочитать сигнатуру чанка (4 байта).
    * Прочитать размер данных чанка (4 байта).
    * Прочитать данные чанка в соответствии с его типом.
    * Перейти к следующему чанку.
