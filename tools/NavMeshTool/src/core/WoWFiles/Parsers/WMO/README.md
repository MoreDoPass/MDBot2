# Структура файла .WMO (World Map Object) (версия для WotLK 3.3.5a)

Этот документ описывает структуру файлов `.WMO`, используемых в World of Warcraft WotLK 3.3.5a, на основе анализа файлов и данных с [wowdev.wiki/WMO](https://wowdev.wiki/WMO).

## Общие принципы

* **Порядок байт (Endianness):** Все числовые данные в WMO файлах хранятся в **Little Endian** порядке.
* **Структура чанков:** WMO файлы состоят из последовательности "чанков" (chunks). Каждый чанк имеет следующую общую структуру:
    1. **Идентификатор чанка (Chunk ID):** 4 байта. В файле хранится в обратном порядке символов (например, `MVER` в коде будет `REVM` в файле).
    2. **Размер данных чанка (Chunk Data Size):** 4 байта, `uint32_t`. Указывает размер данных, следующих *после* этого поля (т.е. не включая сам ID и поле размера).
    3. **Данные чанка (Chunk Data):** Массив байт размером `Chunk Data Size`.

## Типы WMO файлов

Существует два основных типа WMO файлов, которые работают совместно для описания сложных объектов игрового мира: root WMO содержит в себе все .m2 + group WMO ссылки, которые нужно
пропарсить и соединить вместе.

1. **Корневой WMO файл (Root WMO file):**
    * Имя файла обычно выглядит так: `Path\WMOName.wmo`.
    * **Назначение:** Является "оглавлением" или "схемой" всего объекта. Он не содержит фактическую геометрию объекта, а вместо этого определяет:
        * Общую информацию и метаданные (через чанк `MOHD`).
        * Список используемых текстур (`MOTX`) и материалов (`MOMT`).
        * Список M2 моделей (doodads), используемых внутри или вокруг WMO (`MODN`), и информацию об их размещении (`MODD`).
        * Информацию о файлах групп (`MOGI`), из которых состоит геометрия объекта.
        * Данные об освещении (`MOLT`), порталах (`MOPV`, `MOPT`, `MOPR`), скайбоксе (`MOSB`), тумане (`MFOG`) и другие глобальные параметры.

2. **Файл группы WMO (WMO group file):**
    * Имя файла обычно выглядит так: `Path\WMOName_NNN.wmo`, где `NNN` - это трехзначный номер группы (например, `_000`, `_001`). Корневой WMO может ссылаться на множество таких файлов (до 512).
    * **Назначение:** Каждый файл группы содержит фактическую 3D геометрию для отдельной части (например, комнаты, секции здания, элемента ландшафта) общего WMO объекта. Ключевые чанки включают:
        * `MOGP`: Заголовок группы с флагами, ограничивающим объемом и другой метаинформацией.
        * `MOVT`: Вершинные данные (координаты, нормали, текстурные координаты).
        * `MOVI`: Индексы вершин для построения треугольников.
        * `MOPY`: Информация о материалах и свойствах полигонов (включая флаги проходимости).
        * `MOBA`: Данные для рендеринга (батчи).
        * Опционально: `MOCV` (цвета вершин), `MOBN`/`MOBR` (данные для коллизий), `MLIQ` (жидкости).

## 1. Структура Корневого WMO Файла (Root WMO)

Анализ нескольких корневых WMO файлов для WotLK 3.3.5a показал следующую стабильную последовательность основных чанков:

### 1.1. MVER (Map Version) Chunk

* **Расположение:** Всегда первый чанк в корневом WMO файле.
* **Назначение:** Указывает версию формата WMO файла.
* **Структура (12 байт всего):

    ```cpp
    struct MVER_Chunk {
        char     chunk_id[4];        // "REVM" (MVER)
        uint32_t chunk_data_size;  // Размер данных, всегда 4
        uint32_t version;            // Версия формата WMO
    };
    ```

* **Значения для WotLK 3.3.5a:**
  * `version`: Всегда **17**.

### 1.2. MOHD (Map Object Header Data) Chunk

* **Расположение:** Следует сразу за `MVER` чанком.
* **Назначение:** Содержит основную заголовочную информацию для всего WMO, включая количество различных компонентов (текстур, групп, дудадов и т.д.), глобальные флаги и ограничивающий объем.
* **Структура (64 байта данных + 8 байт заголовок чанка):

    ```cpp
    // Структура данных чанка MOHD (64 байта)
    struct MOHD_Data_WotLK {
        uint32_t nTextures;        // Количество текстур (MOTX)
        uint32_t nGroups;          // Количество групп (MOGI и файлов _NNN.wmo)
        uint32_t nPortals;         // Количество порталов (MOPV, MOPT, MOPR)
        uint32_t nLights;          // Количество источников света (MOLT)
        uint32_t nDoodadNames;     // Количество имен M2-моделей/doodads (MODN)
        uint32_t nDoodadDefs;      // Количество размещенных M2-моделей/doodads (MODD). Может быть больше, чем фактически помещается в чанк MODD.
        uint32_t nDoodadSets;      // Количество наборов doodad'ов (MODS)
        uint32_t ambColor;         // Фоновый цвет объекта (BGRA)
        uint32_t wmoID;            // ID объекта (для связи с WMOAreaTable.dbc)
        CAaBox   bounding_box;     // Ограничивающий параллелепипед (6 float: minX,Y,Z, maxX,Y,Z)
        uint16_t flags;            // Флаги WMO (например, 0x1 - не ослаблять вершины, 0x4 - использовать ID жидкости из DBC)
        uint16_t padding_or_lod_count; // В WotLK обычно 0 (padding)
    };
    ```

* **Наблюдения по WotLK 3.3.5a:**
  * Размер данных `MOHD` всегда 64 байта.
  * Поля счетчиков (`nTextures`, `nGroups` и т.д.) определяют размеры последующих чанков.
  * `nDoodadNames` точно соответствует количеству непустых строк в чанке `MODN`.
  * `nDoodadDefs` указывает ожидаемое количество определений дудадов. Однако, если фактический размер чанка `MODD` недостаточен для такого количества, парсер считывает столько определений, сколько физически помещается.
  * `nDoodadSets` часто равен 1.
  * `flags` могут варьироваться (например, 0, 1, 5, 7, 15).

### 1.3. MOTX (Texture Names) Chunk

* **Расположение:** Обычно следует за `MOHD`.
* **Назначение:** Содержит блок имен файлов текстур (обычно `.BLP`), используемых материалами WMO. Имена представляют собой строки, разделенные нулевыми символами. Общий размер блока данных указывается в заголовке чанка, а количество текстур берется из `MOHD.nTextures`.
* **Структура данных:** Последовательность null-terminated строк.

### 1.4. MOMT (Materials) Chunk

* **Расположение:** Обычно следует за `MOTX`.
* **Назначение:** Определяет материалы, используемые WMO. Каждый материал описывает, как текстуры (из `MOTX`) и другие параметры (цвета, флаги смешивания, шейдеры) применяются к геометрии. Количество материалов берется из `MOHD.nTextures` (важно: `nTextures` из `MOHD` определяет количество записей и в `MOTX`, и в `MOMT`).
* **Структура данных:** Массив структур `SMOMaterial` (размер каждой структуры зависит от версии WMO, для WotLK это обычно 64 байта).

    ```cpp
    // Примерная структура SMOMaterial для WotLK (нуждается в уточнении)
    struct SMOMaterial_WotLK {
        uint32_t flags;
        uint32_t shader; // Индекс шейдера (0, 1, 2, ...), соответствует хардкодным шейдерам клиента
        uint32_t blendMode;
        uint32_t texture_1; // Индекс в MOTX
        uint32_t color_1;   // SIDN_OBJECT_COLOR / Diffuse color
        uint32_t flags_1;
        uint32_t texture_2; // Индекс в MOTX
        uint32_t color_2;   // SIDN_OBJECT_EMISSIVE / Emissive color
        uint32_t flags_2;
        uint32_t diffColor; // Diffuse color (если не используется color_1)
        uint32_t groupType; // Terrain type (ground, grass, etc.)
        uint32_t texture_3; // Индекс в MOTX
        uint32_t color_3;
        uint32_t flags_3;
        // ... еще поля, всего 64 байта
    };
    ```

### 1.5. MOGN (Group Names) Chunk

* **Расположение:** Обычно следует за `MOMT`.
* **Назначение:** Содержит блок имен для каждой группы WMO (например, "Комната1", "КоридорЗапад"). Эти имена в основном используются для отладки и не критичны для рендеринга или коллизий. Количество имен соответствует `MOHD.nGroups`.
* **Структура данных:** Последовательность null-terminated строк.

### 1.6. MOGI (Group Information) Chunk

* **Расположение:** Обычно следует за `MOGN`.
* **Назначение:** Содержит информацию о каждой группе геометрии, которая будет загружена из соответствующего файла `_NNN.wmo`. Включает флаги группы, ее ограничивающий объем (bounding box) и другие параметры. Количество записей соответствует `MOHD.nGroups`.
* **Структура данных:** Массив структур `SMOGroupInfo`.

    ```cpp
    // Примерная структура SMOGroupInfo для WotLK (32 байта на запись)
    struct SMOGroupInfo_WotLK {
        uint32_t flags;             // Флаги группы (например, наличие MOCV, MOBN/MOBR, жидкостей)
        CAaBox   bounding_box;      // Ограничивающий объем группы (6 float)
        int32_t  name_offset_or_id; // В WotLK это поле не всегда является прямым смещением в MOGN.
                                    // Оно может быть ID группы, частью флагов, или иметь другое значение (часто -1 или 0).
                                    // Имена групп из MOGN обычно носят описательный характер и не являются критичными для рендеринга.
    };
    ```

    *(Структура уточнена на основе анализа парсера. Парсер считывает 32 байта, включая `flags`, 6 `float` для `bounding_box` и `name_offset_or_id`.)*

### 1.7. MOSB (Skybox Data) Chunk

* **Расположение:** Обычно следует за `MOGI`.
* **Назначение:** Определяет модель скайбокса (фона), который будет отображаться, когда игрок находится внутри этого WMO. Если WMO находится на открытой местности, этот скайбокс может переопределять глобальный скайбокс карты.
* **Структура данных:** Зависит от версии. Для WotLK это часто просто имя `.MDX` (M2) файла скайбокса, если флаг `MOHD.flags & 0x40` не установлен. Если установлен, то это может быть 4-байтовый `uint32_t skybox_dbc_id`. В большинстве WMO WotLK это просто строка с путем к файлу, дополненная нулями до размера чанка.
  * Если размер чанка > 4 и `MOHD.flags & 0x40` не установлен, то это null-terminated строка (имя файла).
  * Если `MOHD.flags & 0x40` установлен (или для некоторых более поздних клиентов) это может быть `uint32 skyboxId` (foreign_key в LightSkybox.dbc).
  * Для 3.3.5a, если `chunk_size` > 0, это путь к `.m2` файлу скайбокса. Если `chunk_size == 0` или первый байт строки ` `, то скайбокс не используется или наследуется.

### 1.8. MOPV (Portal Vertices) Chunk

* **Расположение:** Обычно следует за `MOSB`.
* **Назначение:** Содержит список вершин, которые определяют геометрию порталов. Порталы – это (обычно невидимые) многоугольники, которые соединяют различные группы WMO или WMO с внешним миром, и используются для отсечения невидимой геометрии (culling).
* **Структура данных:** Массив 3D-вершин (3 float на вершину). Количество вершин определяется размером чанка (`chunk_size / 12`).

### 1.9. MOPT (Portal Info) Chunk

* **Расположение:** Обычно следует за `MOPV`.
* **Назначение:** Содержит информацию о каждом портале. Каждый портал описывается как многоугольник, используя вершины из `MOPV`.
* **Структура данных:** Массив структур `SMOPortalInfo` (20 байт на запись в WotLK). Количество порталов (`MOHD.nPortals`) определяет количество этих структур.

    ```cpp
    struct SMOPortalInfo_WotLK { // CPortalInfo
        uint16_t start_vertex_index; // Индекс первой вершины в MOPV
        uint16_t count;              // Количество вершин для этого портала
        C3Vector normal;             // Нормаль портала (3 float)
        float    unknown_or_distance; // Обычно 0.0f или константа
    };
    ```

### 1.10. MOPR (Portal Group Relationship) Chunk

* **Расположение:** Обычно следует за `MOPT`.
* **Назначение:** Описывает связи между порталами и группами WMO. Указывает, какая группа находится "по ту сторону" портала, и является ли переход односторонним или двусторонним. Эта информация критична для системы видимости.
* **Структура данных:** Массив структур `SMOPortalRef` (8 байт на запись в WotLK). Количество записей равно `MOHD.nPortals`.

    ```cpp
    struct SMOPortalRef_WotLK { // CPortalRel
        uint16_t portal_index;  // Индекс портала в MOPT
        uint16_t group_index;   // Индекс группы WMO, к которой ведет портал
        int16_t  side;          // Знак нормали (1 или -1), определяет "лицевую" сторону
        uint16_t filler;        // Обычно 0
    };
    ```

### 1.11. MOVV (Visible Block Vertices) Chunk

* **Расположение:** Обычно следует за `MOPR`.
* **Назначение:** В WotLK и ранее этот чанк обычно пустой (размер данных 0). В более поздних версиях (Cataclysm+) используется для оптимизации видимости.
* **Структура данных:** В WotLK не используется.

### 1.12. MOVB (Visible Block List) Chunk

* **Расположение:** Обычно следует за `MOVV`.
* **Назначение:** Аналогично `MOVV`, в WotLK и ранее этот чанк обычно пустой.
* **Структура данных:** В WotLK не используется.

### 1.13. MOLT (Lights) Chunk

* **Расположение:** Обычно следует за `MOVB`.
* **Назначение:** Содержит информацию об источниках света внутри WMO. Количество источников света определяется `MOHD.nLights`.
* **Структура данных:** Массив структур `SMOLight` (размер структуры зависит от типа света, для WotLK это обычно 48 байт).

    ```cpp
    // Примерная структура SMOLight для WotLK (48 байт)
    struct SMOLight_WotLK {
        uint8_t  type;          // Тип света (0 - точечный, 1 - направленный, 2 - прожектор)
        uint8_t  useAttenuation;
        uint8_t  padding[2];
        uint32_t color;         // Цвет света (ARGB)
        C3Vector position;      // Позиция света (3 float)
        float    intensity;
        float    attenuationStart;
        float    attenuationEnd;
        // ... другие поля (зависят от типа света, например, направление для прожектора)
        // float unknown[4]; для точечного света
        // float direction[3]; для направленного/прожектора
    };
    ```

### 1.14. MODS (Doodad Sets) Chunk

* **Расположение:** Обычно следует за `MOLT`.
* **Назначение:** Описывает "наборы" дудадов (M2-моделей). WMO может иметь несколько наборов дудадов, и клиент может выбирать, какой набор отображать (например, для разных состояний объекта). В WotLK чаще всего используется один набор. Количество наборов определяется `MOHD.nDoodadSets`.
* **Структура данных:** Массив структур `SMODoodadSet` (32 байта на запись).

    ```cpp
    struct SMODoodadSet {
        char     name[20];          // Имя набора (обычно "Set ####")
        uint32_t first_instance_index; // Индекс первого экземпляра дудада в MODD, принадлежащего этому набору
        uint32_t num_doodads;       // Количество дудадов в этом наборе
        uint32_t unused;            // Обычно 0
    };
    ```

### 1.15. MODN (Doodad Names) Chunk

* **Расположение:** Обычно следует за `MODS`.
* **Назначение:** Содержит список имен файлов M2-моделей (дудадов), которые используются в этом WMO. Пути к файлам разделены нулевыми символами. Количество имен M2-моделей, указанное в `MOHD.nDoodadNames`, точно соответствует количеству непустых строк, найденных парсером в данных этого чанка. Эти имена используются для загрузки соответствующих `.m2` файлов.
* **Структура данных:** Последовательность null-terminated строк (пути к `.m2` файлам).

### 1.16. MODD (Doodad Definitions / Placement) Chunk

* **Расположение:** Обычно следует за `MODN`.
* **Назначение:** Содержит информацию о размещении каждого экземпляра M2-модели (дудада) в мире. Для каждого дудада указывается его имя (через смещение в данных `MODN`), позиция, вращение и масштаб. Количество записей, которое парсер пытается прочитать, определяется `MOHD.nDoodadDefs`, но если чанк `MODD` меньше ожидаемого, считывается только то количество определений, которое физически помещается в размер чанка. Это критически важный чанк для NavMesh, так как дудады являются препятствиями.
* **Структура данных:** Массив структур `SMODoodadDef` (40 байт на запись в WotLK).

    ```cpp
    // Структура SMODoodadDef для WotLK (40 байт)
    struct SMODoodadDef_WotLK {
        uint32_t name_offset; // Смещение в блоке данных MODN к имени файла этого дудада.
                              // Чтобы получить имя: &MODN_data[name_offset]
        C3Vector position;    // Позиция (X, Y, Z)
        CQuaternion rotation; // Вращение, компоненты читаются как (X, Y, Z, W)
        float    scale;       // Масштаб (1.0 = нормальный размер)
        uint32_t color;       // Цвет освещения (ABGR, как в vertex color)
    };
    ```

   *(Структура уточнена на основе анализа парсера. Порядок компонентов кватерниона и формат цвета соответствуют тому, как их обрабатывает парсер.)*

### 1.17. MFOG (Fog Information) Chunk

* **Расположение:** Обычно следует за `MODD` и является последним основным чанком в корневом WMO для WotLK.
* **Назначение:** Определяет параметры тумана, который используется внутри WMO. Может переопределять глобальные настройки тумана карты.
* **Структура данных:** Массив структур `SMOFogInfo` (48 байт на запись в WotLK). Количество записей определяется размером чанка (`chunk_size / 48`).

    ```cpp
    // Примерная структура SMOFogInfo для WotLK (48 байт)
    struct SMOFogInfo_WotLK {
        uint32_t flags;
        C3Vector position;      // Позиция центра области тумана
        float    smallerRadius; // Внутренний радиус (полная плотность тумана)
        float    largerRadius;  // Внешний радиус (туман начинает исчезать)
        float    fogEnd;        // Дистанция, на которой туман достигает density_multiplier
        float    fogStartMultiplier; // Плотность тумана у smallerRadius (0.0-1.0)
        uint32_t color;         // Цвет тумана (ARGB)
        // ... еще поля
        // float unknown[2];
        // uint32_t another_unknown_or_blend_factor;
    };
    ```

*(Этот список будет дополняться детальным описанием каждого чанка по мере его анализа и реализации парсера)*

## 2. Структура Файла Группы WMO (Group WMO - `_NNN.wmo`)

Файлы групп WMO (`Path\WMOName_NNN.wmo`) содержат фактическую геометрию и данные для рендеринга отдельных частей WMO объекта.

Каждый файл группы начинается со стандартного чанка `MVER`, за которым следует "супер-чанк" `MOGP`, который, в свою очередь, содержит все остальные чанки геометрии для этой группы.

### 2.1. MVER (Map Version) Chunk

* **Расположение:** Всегда первый чанк в файле группы.
* **Назначение:** Указывает версию формата WMO файла.
* **Структура (12 байт всего):** Идентична `MVER` в корневом WMO.

    ```cpp
    struct MVER_Chunk { // 12 bytes
        char     chunk_id[4];        // "REVM" (MVER)
        uint32_t chunk_data_size;  // Размер данных, всегда 4
        uint32_t version;            // Версия формата WMO (17 для WotLK 3.3.5a)
    };
    ```

### 2.2. MOGP (Map Object Group Properties) Chunk

* **Расположение:** Следует сразу за `MVER` чанком.
* **Назначение:** Является основным контейнером для всех данных группы. Содержит собственный заголовок с метаинформацией о группе, за которым следуют все остальные чанки, описывающие геометрию, материалы, коллизии и т.д. для этой группы.
* **Общая структура MOGP чанка:**
    1. **Chunk ID:** 4 байта (`"PGOM"`).
    2. **Chunk Data Size:** 4 байта (`uint32_t`), общий размер всех данных *внутри* MOGP, включая его 64-байтный заголовок и все вложенные чанки.
    3. **Данные MOGP:**
        * **Заголовок MOGP (MOGP Header):** 64 байта для WotLK 3.3.5a (см. структуру ниже).
        * **Вложенные чанки:** Последовательность других чанков (например, `MOPY`, `MOVI`, `MOVT`, `MOBA` и т.д.), специфичных для этой группы. Общий размер этих вложенных чанков равен `MOGP_Chunk_Data_Size - 64`.

* **Структура заголовка MOGP (MOGP Header) для WotLK 3.3.5a (64 байта):**

    ```cpp
    // Этот 64-байтный заголовок идет сразу после ID "PGOM" и общего размера MOGP.
    struct MOGP_Header_WotLK { // 64 bytes total
        uint32_t groupNameOffset;        // Смещение в MOGN корневого WMO (или -1/0). Ссылается на имя группы.
        uint32_t descriptiveGroupNameOffset; // Смещение в MOGN корневого WMO. Ссылается на более подробное имя.
        uint32_t flags;                  // Флаги группы (например, наличие MOCV, MOBN/MOBR, тип освещения, наличие жидкости и т.д.). Подробное описание см. на wowdev.wiki.
        
        // Bounding Box (ограничивающий параллелепипед группы в локальных для WMO координатах)
        float    bb_min_x, bb_min_y, bb_min_z;
        float    bb_max_x, bb_max_y, bb_max_z;

        uint16_t portal_start_index;     // Индекс первого портала этой группы в MOPR корневого WMO. Порталы связывают группы.
        uint16_t portal_count;           // Количество порталов, используемых этой группой.

        // Количество "батчей" (render batches) для рендеринга геометрии
        uint16_t transBatchCount;        // Количество прозрачных/полупрозрачных батчей
        uint16_t interiorBatchCount;     // Количество батчей для внутренней геометрии
        uint16_t exteriorBatchCount;     // Количество батчей для внешней геометрии
        uint16_t padding_or_batch_type_d; // Обычно 0, возможно выравнивание или неиспользуемый тип батча.

        uint8_t  fogIds[4];              // Индексы в чанк MFOG корневого WMO, определяющие параметры тумана для этой группы.
        uint32_t liquid_type_or_flags;   // ID типа жидкости (ссылка на LiquidType.dbc) или флаги, связанные с MLIQ чанком.
        uint32_t wmo_group_id;           // Уникальный идентификатор этой группы внутри WMO (не путать с WMOAreaTable.dbc ID).
        
        uint32_t wotlk_flags2;           // Поле, соответствующее flags2 на wowdev.wiki. Для WotLK это, вероятно, просто uint32_t, может содержать доп. флаги или быть частично padding.
        uint32_t wotlk_unk_padding;      // Дополнительные 4 байта, вероятно, неиспользуемые или для выравнивания до 64 байт.
    };
    ```

### 2.3. Последовательность вложенных чанков в MOGP

После 64-байтного заголовка MOGP следуют другие чанки, специфичные для группы. Типичная (но не строго обязательная) последовательность может включать следующие чанки:

* **MOPY (Material Info / Polygon Flags):** Определяет свойства полигонов (треугольников), включая флаги проходимости и индекс материала.

    ```cpp
    struct SMOPoly { // 2 байта на полигон (треугольник)
        uint8_t flags;       // Флаги полигона (например, проходимость, тип поверхности)
        uint8_t material_id; // Индекс материала в MOMT чанке корневого WMO. Определяет, какая текстура и свойства материала применяются.
    };
    // Количество записей SMOPoly обычно равно количеству треугольников в группе.
    ```

* **MOVI (Vertex Indices):** Индексы вершин для построения треугольников. Каждый индекс - это `uint16_t`. Индексы идут последовательно и группируются по три для каждого треугольника.

    ```cpp
    // Пример: uint16_t indices[] = {vert0, vert1, vert2,  vert3, vert4, vert5, ...};
    // Первый треугольник использует вершины indices[0], indices[1], indices[2].
    // Второй треугольник использует вершины indices[3], indices[4], indices[5].
    // И так далее.
    // Общее количество индексов = количество треугольников * 3.
    ```

* **MOVT (Vertices):** Данные вершин. В WotLK каждая вершина обычно содержит координаты позиции, нормаль и одну пару текстурных координат.

    ```cpp
    struct C3Vector { // 3 * 4 = 12 байт
        float x, y, z;
    };

    struct C2Vector { // 2 * 4 = 8 байт
        float u, v;
    };

    struct SMOVertex { // 3 * 4 + 3 * 4 + 2 * 4 = 12 + 12 + 8 = 32 байта
        C3Vector position;
        C3Vector normal;
        C2Vector tex_coords;
    };
    // Чанк MOVT содержит массив таких структур SMOVertex.
    // Иногда размер чанка MOVT может быть не строго кратен 32 байтам,
    // что указывает на возможное наличие padding байтов в конце чанка.
    ```

* **MONR (Normals):** Нормали вершин (если флаг `MOGP.flags & 0x8` установлен, указывая, что нормали хранятся отдельно от MOVT). Структура аналогична `C3Vector` для каждой нормали.
* **MOTV (Texture Coordinates):** Текстурные координаты (если не включены в MOVT, может быть несколько блоков для разных слоев текстур). Структура аналогична `C2Vector` для каждой пары координат. Флаги в `MOGP.flags` (например, `0x40000` для второго слоя) указывают на наличие дополнительных блоков MOTV.
* **MOBA (Render Batches):** Информация о батчах для рендеринга. Определяет, какие группы треугольников как рендерятся (например, материал, порядок).
* **MOCV (Vertex Colors):** Цвета вершин (если флаг установлен в MOGP.flags).
* **MLIQ (Liquid Data):** Определяет данные о жидкостях (вода, лава, слизь и т.д.) внутри группы WMO. Наличие этого чанка обычно указывается флагом `0x2000` в `MOGP.flags`. Содержит заголовок с размерами сетки жидкости, координаты ее угла, ID материала, а затем данные о вершинах и тайлах жидкости.

    ```cpp
    // Заголовок чанка MLIQ (30 байт)
    struct MLIQ_Header {
        int32_t  xverts;          // Количество вершин по оси X (ширина сетки + 1)
        int32_t  yverts;          // Количество вершин по оси Y (длина сетки + 1)
        int32_t  xtiles;          // Количество тайлов по оси X (ширина сетки)
        int32_t  ytiles;          // Количество тайлов по оси Y (длина сетки)
        C3Vector liquid_corner;   // Координаты (X, Y, Z) угла сетки жидкости.
                                  // Обычно это min_X, min_Y, но Z может быть другим.
        uint16_t liquid_mtl_id;   // ID материала (индекс в MOMT чанке корневого WMO),
                                  // используемый для рендеринга этой жидкости.
                                  // Это поле не всегда напрямую указывает тип жидкости.
                                  // Тип жидкости часто определяется полем MOGP.liquid_type_or_flags
                                  // и флагами MOGP.flags (например, 0x80000 - is_not_water_but_ocean)
                                  // и/или флагами самого материала из MOMT.
    };

    // Данные вершин жидкости (SMOLVert). Для WotLK чаще всего используется структура для воды.
    // Каждая вершина занимает 8 байт.
    // Общий размер данных вершин = header.xverts * header.yverts * 8 байт.
    struct SMOWaterVert { // 8 байт
        uint8_t flow1;      // Данные о потоке (направление/скорость)
        uint8_t flow2;      // Данные о потоке
        uint8_t flow1Pct;   // Процент влияния flow1 (сила потока?)
        uint8_t filler;     // Не используется / выравнивание
        float   height;     // Высота этой вершины жидкости относительно liquid_corner.z
                            // (т.е. абсолютная высота Z = liquid_corner.z + height)
    };
    // SMOLVert liquid_vertex_list[header.xverts * header.yverts];

    // Данные тайлов жидкости (SMOLTile).
    // Каждый тайл занимает 1 байт.
    // Общий размер данных тайлов = header.xtiles * header.ytiles * 1 байт.
    struct SMOLTile { // 1 байт
        uint8_t legacy_liquid_type : 4; // Для старых WMO, мог указывать тип жидкости.
                                        // 0x0F (15) - часто встречается для "воды" из MLIQ в WotLK.
        uint8_t unknown1           : 1; // Неизвестный флаг
        uint8_t unknown2           : 1; // Неизвестный флаг
        uint8_t fishable           : 1; // Можно ли ловить рыбу в этом тайле
        uint8_t shared             : 1; // Неизвестный флаг (возможно, связан с общими краями тайлов)
    };
    // SMOLTile liquid_tile_list[header.xtiles * header.ytiles];
    ```

* **MOBN / MOBR (Collision BSP Tree):** Данные для коллизий. `MOBN` содержит узлы BSP-дерева, а `MOBR` содержит индексы полигонов (треугольников), на которые ссылаются листовые узлы BSP-дерева. Флаг в `MOGP.flags` (например, `0x800` - Has MOBN/MOBR chunk) обычно указывает на их наличие. ПОКАЗЫВАЕТ РЕАЛЬНЫЙ РАЗМЕР ПРЕПЯТСТВИЙ НА ПОВЕРХНОСТИ.

    **MOBN (Map Object BSP Nodes):** Массив структур `CAaBspNode`.

    ```cpp
    // Структура узла BSP-дерева (16 байт)
    struct CAaBspNode {
        // Флаги узла.
        // Бит 0-1 (mask 0x3): тип плоскости:
        //   0x0: YZ-плоскость (нормаль по X)
        //   0x1: XZ-плоскость (нормаль по Y)
        //   0x2: XY-плоскость (нормаль по Z)
        // Бит 2 (mask 0x4): если установлен, узел является листом (leaf node).
        //                  Если не установлен, это узел-ветвь (branch node).
        uint16_t flags;

        // Индексы дочерних узлов в этом же массиве MOBN.
        // Если значение -1 (0xFFFF), соответствующего дочернего узла нет.
        // Для листовых узлов оба дочерних узла обычно -1.
        int16_t  negChild;     // Индекс дочернего узла с отрицательной стороны разделяющей плоскости.
        int16_t  posChild;     // Индекс дочернего узла с положительной стороны разделяющей плоскости.

        // Для листовых узлов (flags & 0x4):
        //   nFaces: Количество полигонов (треугольников) коллизий, связанных с этим листом.
        //   faceStart: Начальный индекс в чанке MOBR для этих полигонов.
        // Для узлов-ветвей эти поля обычно равны 0.
        uint16_t nFaces;
        uint32_t faceStart;    // Использует uint32_t для хранения индекса, хотя nFaces - uint16_t.

        // Расстояние от начала координат WMO до разделяющей плоскости вдоль оси, 
        // определенной в flags (0x0-0x2).
        // Для листовых узлов это поле часто равно 0.
        float    planeDist;
    };
    ```

    **MOBR (Map Object BSP References/RenderBatches):** Массив индексов `uint16_t`.

    ```cpp
    // Каждый элемент в MOBR - это индекс треугольника в чанке MOVI этой же группы.
    // uint16_t mobr_triangle_indices[]; 
    // 
    // Чтобы получить фактические индексы вершин из MOVT для полигона коллизий:
    // 1. Для листового узла MOBN.CAaBspNode node:
    // 2.   for (int i = 0; i < node.nFaces; ++i) {
    // 3.     uint16_t movi_triangle_index = MOBR_data[node.faceStart + i];
    // 4.     uint16_t v_idx0 = MOVI_data[movi_triangle_index * 3 + 0];
    // 5.     uint16_t v_idx1 = MOVI_data[movi_triangle_index * 3 + 1];
    // 6.     uint16_t v_idx2 = MOVI_data[movi_triangle_index * 3 + 2];
    // 7.     // Вершины: MOVT_data[v_idx0], MOVT_data[v_idx1], MOVT_data[v_idx2]
    // 8.   }
    // ```

* **MODR (Doodad References):** Ссылки на дудады, специфичные для этой группы (если флаг установлен).

Порядок и наличие этих вложенных чанков определяется флагами в `MOGP.flags` и данными самого WMO. Парсер должен читать ID и размер каждого вложенного чанка, пока не будет прочитано `MOGP_Chunk_Total_Data_Size - 64` байт данных.

*(Этот раздел будет дополняться по мере анализа конкретных вложенных чанков)*

## 3. Ключевые данные WMO для построения NavMesh

Для построения навигационной сетки (NavMesh) из WMO объектов, необходимы следующие основные компоненты:

1. **Из файлов групп (`_NNN.wmo`):**
    * **Вершины (`MOVT`):** Координаты вершин, формирующих геометрию.
    * **Индексы треугольников (`MOVI`):** Определяют, как вершины соединяются в треугольники.
    * **Информация о материалах/полигонах (`MOPY`):** Содержит флаги проходимости (`F_WALKABLE`, `F_UNWALKABLE` и т.п.) для каждого треугольника или группы треугольников. Это критически важно для определения, какие поверхности являются частью NavMesh.
    * **(Опционально, для большей точности) Данные коллизий (`MOBN`, `MOBR`):** Если присутствуют, могут предоставить более точную геометрию для столкновений, чем визуальные треугольники.
    * **Флаги группы (`MOGP.flags`):** Могут содержать общие флаги проходимости или свойства группы.

2. **Из корневого WMO (`.wmo`):**
    * **Размещение M2-моделей/doodads (`MODD`):** Позиции, вращение и масштабы для всех M2 моделей, размещенных внутри или вокруг WMO. Геометрия коллизий этих M2 моделей (если они ее имеют) также должна быть учтена как препятствия на NavMesh.
    * **Информация о группах (`MOGI`):** Для связи данных из корневого файла с конкретными файлами групп.

**Важно учитывать при построении глобального NavMesh:**

* Геометрия из файлов групп WMO уже находится в мировых координатах (или легко преобразуется в них на основе данных из `MOGP` и, возможно, `MODF` из ADT для глобального позиционирования самого WMO).
* M2-модели (doodads), на которые ссылается WMO, хранят свою геометрию в локальном пространстве. Их необходимо трансформировать в мировое пространство согласно данным из `MODD` чанка WMO (и, если WMO сам размещен на ADT, то дополнительно трансформировать согласно данным из `MODF` чанка ADT).
